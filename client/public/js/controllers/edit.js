(function() {
  var controllers;

  controllers = angular.module('moedit.Controllers');

  controllers.controller('editController', [
    '$scope', '$log', '$q', '$state', '$stateParams', '$window', 'moedit.Socket', 'moedit.SweetAlert', 'moedit.Focus', 'moedit.Data', 'messageCenterService', 'ngDialog', function($scope, $log, $q, $state, $stateParams, $window, Socket, SweetAlert, Focus, Data, messageCenterService, ngDialog) {
      var autoSave, autoSaveCurrentDocument, chapterchange, highlightComment, unhighlightAllComments, unhighlightComment;
      autoSaveCurrentDocument = function() {
        $log.debug("autosave");
        return $scope.saveDocument($scope.currentDocument, "Automatisch gespeichert");
      };
      autoSave = _.debounce(autoSaveCurrentDocument, 5000);
      $scope.selectChapter = function(chapter) {
        var c, _i, _len, _ref;
        $log.info("select chapter " + chapter.title + ":" + chapter.selected);
        unhighlightAllComments();
        if ($scope.chapterWatch != null) {
          $scope.chapterWatch();
        }
        $scope.currentChapter = chapter;
        _ref = $scope.currentDocument.chapters;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c._id === chapter._id) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        return $scope.chapterWatch = $scope.$watch('currentChapter.content', chapterchange, true);
      };
      $scope.selectComment = function(comment) {
        var c, _i, _len, _ref;
        unhighlightComment($scope.currentComment);
        $log.info("select comment: " + comment.text + ":" + comment.selected);
        $scope.currentComment = comment;
        _ref = $scope.currentChapter.comments;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c.key === comment.key) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        highlightComment($scope.currentComment);
        return true;
      };
      highlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).addClass('comment-highlight');
        }
      };
      unhighlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).removeClass('comment-highlight');
        }
      };
      unhighlightAllComments = function() {
        return $(".comment").removeClass('comment-highlight');
      };
      chapterchange = function(newValue, oldValue) {
        var comment, r, removeMe, _i, _j, _len, _len1, _ref;
        $log.debug("changed:: " + $scope.currentChapter.content);
        if (newValue !== oldValue) {
          $scope.currentChapter.lastChanged = new Date();
          if ($scope.commentRemoval) {
            removeMe = [];
            _ref = $scope.currentChapter.comments;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              comment = _ref[_i];
              if (newValue.indexOf(comment.key) < 0) {
                removeMe.push(comment);
              }
            }
            for (_j = 0, _len1 = removeMe.length; _j < _len1; _j++) {
              r = removeMe[_j];
              $scope.deleteComment(r);
            }
            return autoSave();
          }
        }
      };
      $scope.newComment = function(chapter, commentKey) {
        var dialog;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          var comment;
          console.log("key: " + commentKey + ", text: " + dialogData.value);
          comment = {
            author: chance.name(),
            key: commentKey,
            created: new Date(),
            text: dialogData.value
          };
          console.dir(chapter);
          chapter.comments.push(comment);
          return autoSave();
        });
      };
      $scope.newChapter = function(document) {
        document.chapters.push({
          title: $scope.newChapterTitle,
          author: chance.name(),
          lastChanged: new Date(),
          state: 'ONGOING',
          comments: [],
          version: 1
        });
        $scope.newChapterTitle = '';
        $scope.selectChapter(_.last(document.chapters));
        return autoSave();
      };
      $scope.saveDocument = function(document, msg) {
        if (msg == null) {
          msg = "Gutachten erfolgreich gespeichert";
        }
        return Data.saveDocument(document).then(function(response) {
          if (response.status !== 200) {
            return messageCenterService.add('danger', msg, {
              html: true
            });
          } else {
            return messageCenterService.add('success', msg, {
              timeout: 2000,
              html: true
            });
          }
        });
      };
      $scope.docStateChanged = function(val) {
        return console.log($scope.currentDocument.state);
      };
      $scope.deleteComment = function(comment) {
        var r;
        unhighlightComment(comment);
        r = new RegExp("<span id=\"" + comment.key + "\" class=\".*?\">");
        $scope.currentChapter.content.replace(r, '', 'g');
        _.remove($scope.currentChapter.comments, function(c) {
          return c.key === comment.key;
        });
        return autoSave();
      };
      $scope.editComment = function(comment) {
        var dialog;
        $scope.newCommentText = comment.text;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          console.log("key: " + comment.key + ", text: " + dialogData.value);
          comment.text = dialogData.value;
          return autoSave();
        });
      };
      if ($stateParams.docid) {
        return Data.document($stateParams.docid).then(function(document) {
          console.dir(document);
          $scope.currentDocument = document;
          return $scope.selectChapter($scope.currentDocument.chapters[0]);
        });
      } else {
        return $state.go('list');
      }
    }
  ]);

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxXQUFBOztBQUFBLEVBQUEsV0FBQSxHQUFjLE9BQU8sQ0FBQyxNQUFSLENBQWdCLG9CQUFoQixDQUFkLENBQUE7O0FBQUEsRUFDQSxXQUFXLENBQUMsVUFBWixDQUF3QixnQkFBeEIsRUFBeUM7SUFDdkMsUUFEdUMsRUFFdkMsTUFGdUMsRUFHdkMsSUFIdUMsRUFJdkMsUUFKdUMsRUFLdkMsY0FMdUMsRUFNdkMsU0FOdUMsRUFPdkMsZUFQdUMsRUFRdkMsbUJBUnVDLEVBU3ZDLGNBVHVDLEVBVXZDLGFBVnVDLEVBV3ZDLHNCQVh1QyxFQVl2QyxVQVp1QyxFQWF4QyxTQUFDLE1BQUQsRUFBUyxJQUFULEVBQWUsRUFBZixFQUFtQixNQUFuQixFQUEyQixZQUEzQixFQUF5QyxPQUF6QyxFQUFrRCxNQUFsRCxFQUEwRCxVQUExRCxFQUFzRSxLQUF0RSxFQUE2RSxJQUE3RSxFQUFtRixvQkFBbkYsRUFBeUcsUUFBekcsR0FBQTtBQUdDLFVBQUEsOEdBQUE7QUFBQSxNQUFBLHVCQUFBLEdBQTBCLFNBQUEsR0FBQTtBQUN6QixRQUFBLElBQUksQ0FBQyxLQUFMLENBQVksVUFBWixDQUFBLENBQUE7ZUFDQSxNQUFNLENBQUMsWUFBUCxDQUFvQixNQUFNLENBQUMsZUFBM0IsRUFBNkMseUJBQTdDLEVBRnlCO01BQUEsQ0FBMUIsQ0FBQTtBQUFBLE1BSUEsUUFBQSxHQUFXLENBQUMsQ0FBQyxRQUFGLENBQVcsdUJBQVgsRUFBb0MsSUFBcEMsQ0FKWCxDQUFBO0FBQUEsTUFNQSxNQUFNLENBQUMsYUFBUCxHQUF1QixTQUFDLE9BQUQsR0FBQTtBQUN0QixZQUFBLGlCQUFBO0FBQUEsUUFBQSxJQUFJLENBQUMsSUFBTCxDQUFXLGlCQUFBLEdBQWlCLE9BQU8sQ0FBQyxLQUF6QixHQUErQixHQUEvQixHQUFrQyxPQUFPLENBQUMsUUFBckQsQ0FBQSxDQUFBO0FB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R0FBZSxVQUFVLENBQUMsS0FGMUIsQ0FBQTtpQkFHQSxRQUFBLENBQUEsRUFKd0I7UUFBQSxDQUF6QixFQUxvQjtNQUFBLENBbkdyQixDQUFBO0FBK0dBLE1BQUEsSUFBRyxZQUFZLENBQUMsS0FBaEI7ZUFDQyxJQUFJLENBQUMsUUFBTCxDQUFjLFlBQVksQ0FBQyxLQUEzQixDQUFpQyxDQUFDLElBQWxDLENBQXVDLFNBQUMsUUFBRCxHQUFBO0FBQ3RDLFVBQUEsT0FBTyxDQUFDLEdBQVIsQ0FBWSxRQUFaLENBQUEsQ0FBQTtBQUFBLFVBQ0EsTUFBTSxDQUFDLGVBQVAsR0FBeUIsUUFEekIsQ0FBQTtpQkFFQSxNQUFNLENBQUMsYUFBUCxDQUFxQixNQUFNLENBQUMsZUFBZSxDQUFDLFFBQVMsQ0FBQSxDQUFBLENBQXJELEVBSHNDO1FBQUEsQ0FBdkMsRUFERDtPQUFBLE1BQUE7ZUFNQyxNQUFNLENBQUMsRUFBUCxDQUFXLE1BQVgsRUFORDtPQWxIRDtJQUFBLENBYndDO0dBQXpDLENBREEsQ0FBQTtBQUFBIiwiZmlsZSI6ImNvbnRyb2xsZXJzL2VkaXQuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJjb250cm9sbGVycyA9IGFuZ3VsYXIubW9kdWxlKCdtb2VkaXQuQ29udHJvbGxlcnMnKVxyXG5jb250cm9sbGVycy5jb250cm9sbGVyICdlZGl0Q29udHJvbGxlcicsIFtcclxuXHQnJHNjb3BlJ1xyXG5cdCckbG9nJ1xyXG5cdCckcSdcclxuXHQnJHN0YXRlJ1xyXG5cdCckc3RhdGVQYXJhbXMnXHJcblx0JyR3aW5kb3cnXHJcblx0J21vZWRpdC5Tb2NrZXQnXHJcblx0J21vZWRpdC5Td2VldEFsZXJ0J1xyXG5cdCdtb2VkaXQuRm9jdXMnXHJcblx0J21vZWRpdC5EYXRhJ1xyXG5cdCdtZXNzYWdlQ2VudGVyU2VydmljZSdcclxuXHQnbmdEaWFsb2cnXHJcblx0KCRzY29wZSwgJGxvZywgJHEsICRzdGF0ZSwgJHN0YXRlUGFyYW1zLCAkd2luZG93LCBTb2NrZXQsIFN3ZWV0QWxlcnQsIEZvY3VzLCBEYXRhLCBtZXNzYWdlQ2VudGVyU2VydmljZSwgbmdEaWFsb2cpIC0+XHJcblxyXG5cdFx0IyBhdXRvc2F2ZVxyXG5cdFx0YXV0b1NhdmVDdXJyZW50RG9jdW1lbnQgPSAoKSAtPlxyXG5cdFx0XHQkbG9nLmRlYnVnIFwiYXV0b3NhdmVcIlxyXG5cdFx0XHQkc2NvcGUuc2F2ZURvY3VtZW50KCRzY29wZS5jdXJyZW50RG9jdW1lbnQsIFwiQXV0b21hdGlzY2ggZ2VzcGVpY2hlcnRcIilcclxuXHRcdFxyXG5cdFx0YXV0b1NhdmUgPSBfLmRlYm91bmNlIGF1dG9TYXZlQ3VycmVudERvY3VtZW50LCA1MDAwXHJcblxyXG5cdFx0JHNjb3BlLnNlbGVjdENoYXB0ZXIgPSAoY2hhcHRlcikgLT5cclxuXHRcdFx0JGxvZy5pbmZvIFwic2VsZWN0IGNoYXB0ZXIgI3tjaGFwdGVyLnRpdGxlfToje2NoYXB0ZXIuc2VsZWN0ZWR9XCJcclxuXHRcdFx0dW5oaWdobGlnaHRBbGxDb21tZW50cygpXHJcblx0XHRcdGlmICRzY29wZS5jaGFwdGVyV2F0Y2g/XHJcblx0XHRcdFx0JHNjb3BlLmNoYXB0ZXJXYXRjaCgpICMgcmVtb3ZlIHdhdGNoXHJcblx0XHRcdCRzY29wZS5jdXJyZW50Q2hhcHRlciA9IGNoYXB0ZXJcclxuXHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnREb2N1bWVudC5jaGFwdGVyc1xyXG5cdFx0XHRcdGlmIGMuX2lkID09IGNoYXB0ZXIuX2lkXHJcblx0XHRcdFx0XHRjLnNlbGVjdGVkID0gdHJ1ZVxyXG5cdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSBmYWxzZVxyXG5cdFx0XHQkc2NvcGUuY2hhcHRlcldhdGNoID0gJHNjb3BlLiR3YXRjaCAnY3VycmVudENoYXB0ZXIuY29udGVudCcsIGNoYXB0ZXJjaGFuZ2UsIHRydWVcclxuXHJcblx0XHQkc2NvcGUuc2VsZWN0Q29tbWVudCA9IChjb21tZW50KSAtPlxyXG5cdFx0XHR1bmhpZ2hsaWdodENvbW1lbnQoJHNjb3BlLmN1cnJlbnRDb21tZW50KVxyXG5cdFx0XHQkbG9nLmluZm8gXCJzZWxlY3QgY29tbWVudDogI3tjb21tZW50LnRleHR9OiN7Y29tbWVudC5zZWxlY3RlZH1cIlxyXG5cdFx0XHQkc2NvcGUuY3VycmVudENvbW1lbnQgPSBjb21tZW50XHJcblx0XHRcdGZvciBjIGluICRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50c1xyXG5cdFx0XHRcdGlmIGMua2V5ID09IGNvbW1lbnQua2V5XHJcblx0XHRcdFx0XHRjLnNlbGVjdGVkID0gdHJ1ZVxyXG5cdFx0XHRcdGVsc2VcclxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSBmYWxzZVxyXG5cdFx0XHRoaWdobGlnaHRDb21tZW50KCRzY29wZS5jdXJyZW50Q29tbWVudClcclxuXHRcdFx0cmV0dXJuIHRydWUgIyB0aGlzIGlzIGJlY2F1c2UgYW5ndWxhciBpcyBjb21wbGFpbmcgYWJvdXQ6IFwiUmVmZXJlbmNpbmcgYSBET00gbm9kZSBpbiBFeHByZXNzaW9uXCIgd2hlbiBqdXN0IHJldHVybmluZyBzb21ldGhpbmcgZWxzZVxyXG5cclxuXHRcdGhpZ2hsaWdodENvbW1lbnQgPSAoY29tbWVudCkgLT5cclxuXHRcdFx0aWYgY29tbWVudD9cclxuXHRcdFx0XHQkKFwiIyN7Y29tbWVudC5rZXl9XCIpLmFkZENsYXNzKCdjb21tZW50LWhpZ2hsaWdodCcpXHJcblxyXG5cdFx0dW5oaWdobGlnaHRDb21tZW50ID0gKGNvbW1lbnQpIC0+XHJcblx0XHRcdGlmIGNvbW1lbnQ/XHJcblx0XHRcdFx0JChcIiMje2NvbW1lbnQua2V5fVwiKS5yZW1vdmVDbGFzcygnY29tbWVudC1oaWdobGlnaHQnKVxyXG5cclxuXHRcdHVuaGlnaGxpZ2h0QWxsQ29tbWVudHMgPSAoKSAtPlxyXG5cdFx0XHQkKFwiLmNvbW1lbnRcIikucmVtb3ZlQ2xhc3MoJ2NvbW1lbnQtaGlnaGxpZ2h0JylcclxuXHJcblx0XHRjaGFwdGVyY2hhbmdlID0gKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgLT5cclxuXHRcdFx0JGxvZy5kZWJ1ZyBcImNoYW5nZWQ6OiAjeyRzY29wZS5jdXJyZW50Q2hhcHRlci5jb250ZW50fVwiXHJcblx0XHRcdGlmIG5ld1ZhbHVlICE9IG9sZFZhbHVlXHJcblx0XHRcdFx0JHNjb3BlLmN1cnJlbnRDaGFwdGVyLmxhc3RDaGFuZ2VkID0gbmV3IERhdGUoKVxyXG5cdFx0XHRcdGlmICRzY29wZS5jb21tZW50UmVtb3ZhbFxyXG5cdFx0XHRcdFx0cmVtb3ZlTWUgPSBbXVxyXG5cdFx0XHRcdFx0Zm9yIGNvbW1lbnQgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXHJcblx0XHRcdFx0XHRcdGlmIG5ld1ZhbHVlLmluZGV4T2YoY29tbWVudC5rZXkpIDwgMFxyXG5cdFx0XHRcdFx0XHRcdHJlbW92ZU1lLnB1c2ggY29tbWVudFxyXG5cdFx0XHRcdFx0Zm9yIHIgaW4gcmVtb3ZlTWVcclxuXHRcdFx0XHRcdFx0JHNjb3BlLmRlbGV0ZUNvbW1lbnQgclxyXG5cdFx0XHRcdFx0YXV0b1NhdmUoKVx0XHJcblxyXG5cdFx0JHNjb3BlLm5ld0NvbW1lbnQgPSAoY2hhcHRlciwgY29tbWVudEtleSkgLT5cclxuXHRcdFx0ZGlhbG9nID0gbmdEaWFsb2cub3BlblxyXG5cdFx0XHRcdHRlbXBsYXRlOiAnY29tbWVudC1pbnB1dC1kaWFsb2cnXHJcblx0XHRcdFx0c2NvcGU6ICRzY29wZVxyXG5cdFx0XHRkaWFsb2cuY2xvc2VQcm9taXNlLnRoZW4gKGRpYWxvZ0RhdGEpIC0+XHJcblx0XHRcdFx0Y29uc29sZS5sb2cgXCJrZXk6ICN7Y29tbWVudEtleX0sIHRleHQ6ICN7ZGlhbG9nRGF0YS52YWx1ZX1cIlxyXG5cdFx0XHRcdGNvbW1lbnQgPSBcclxuXHRcdFx0XHRcdGF1dGhvcjogY2hhbmNlLm5hbWUoKVxyXG5cdFx0XHRcdFx0a2V5OiBjb21tZW50S2V5XHJcblx0XHRcdFx0XHRjcmVhdGVkOiBuZXcgRGF0ZSgpXHJcblx0XHRcdFx0XHR0ZXh0OiBkaWFsb2dEYXRhLnZhbHVlXHJcblx0XHRcdFx0Y29uc29sZS5kaXIgY2hhcHRlclxyXG5cdFx0XHRcdGNoYXB0ZXIuY29tbWVudHMucHVzaCBjb21tZW50XHJcblx0XHRcdFx0YXV0b1NhdmUoKVxyXG5cclxuXHRcdCRzY29wZS5uZXdDaGFwdGVyID0gKGRvY3VtZW50KSAtPlxyXG5cdFx0XHRkb2N1bWVudC5jaGFwdGVycy5wdXNoXHJcblx0XHRcdFx0dGl0bGU6ICRzY29wZS5uZXdDaGFwdGVyVGl0bGVcclxuXHRcdFx0XHRhdXRob3I6IGNoYW5jZS5uYW1lKClcclxuXHRcdFx0XHRsYXN0Q2hhbmdlZDogbmV3IERhdGUoKVxyXG5cdFx0XHRcdHN0YXRlOiAnT05HT0lORydcclxuXHRcdFx0XHRjb21tZW50czogW11cclxuXHRcdFx0XHR2ZXJzaW9uOiAxXHJcblx0XHRcdCRzY29wZS5uZXdDaGFwdGVyVGl0bGUgPSAnJ1xyXG5cdFx0XHQkc2NvcGUuc2VsZWN0Q2hhcHRlcihfLmxhc3QgZG9jdW1lbnQuY2hhcHRlcnMpXHJcblx0XHRcdGF1dG9TYXZlKClcclxuXHJcblx0XHQkc2NvcGUuc2F2ZURvY3VtZW50ID0gKGRvY3VtZW50LCBtc2cgPSBcIkd1dGFjaHRlbiBlcmZvbGdyZWljaCBnZXNwZWljaGVydFwiKSAtPlxyXG5cdFx0XHREYXRhLnNhdmVEb2N1bWVudChkb2N1bWVudCkudGhlbiAocmVzcG9uc2UpIC0+XHJcblx0XHRcdFx0aWYgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMFxyXG5cdFx0XHRcdFx0bWVzc2FnZUNlbnRlclNlcnZpY2UuYWRkKCdkYW5nZXInLCBtc2csIHtodG1sOiB0cnVlfSk7XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0bWVzc2FnZUNlbnRlclNlcnZpY2UuYWRkKCdzdWNjZXNzJywgbXNnLCB7dGltZW91dDogMjAwMCwgaHRtbDogdHJ1ZX0pO1xyXG5cclxuXHRcdCRzY29wZS5kb2NTdGF0ZUNoYW5nZWQgPSAodmFsKSAtPlxyXG5cdFx0XHRjb25zb2xlLmxvZyAkc2NvcGUuY3VycmVudERvY3VtZW50LnN0YXRlXHJcblxyXG5cdFx0JHNjb3BlLmRlbGV0ZUNvbW1lbnQgPSAoY29tbWVudCkgLT5cclxuXHRcdFx0dW5oaWdobGlnaHRDb21tZW50KGNvbW1lbnQpXHJcblx0XHRcdHIgPSBuZXcgUmVnRXhwIFwiPHNwYW4gaWQ9XFxcIiN7Y29tbWVudC5rZXl9XFxcIiBjbGFzcz1cXFwiLio/XFxcIj5cIlxyXG5cdFx0XHQkc2NvcGUuY3VycmVudENoYXB0ZXIuY29udGVudC5yZXBsYWNlIHIsICcnLCAnZydcclxuXHRcdFx0Xy5yZW1vdmUoJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzLCAoYykgLT4gYy5rZXkgPT0gY29tbWVudC5rZXkpXHJcblx0XHRcdGF1dG9TYXZlKClcclxuXHJcblx0XHQkc2NvcGUuZWRpdENvbW1lbnQgPSAoY29tbWVudCkgLT4gXHJcblx0XHRcdCRzY29wZS5uZXdDb21tZW50VGV4dCA9IGNvbW1lbnQudGV4dFxyXG5cdFx0XHRkaWFsb2cgPSBuZ0RpYWxvZy5vcGVuXHJcblx0XHRcdFx0dGVtcGxhdGU6ICdjb21tZW50LWlucHV0LWRpYWxvZydcclxuXHRcdFx0XHRzY29wZTogJHNjb3BlXHJcblx0XHRcdGRpYWxvZy5jbG9zZVByb21pc2UudGhlbiAoZGlhbG9nRGF0YSkgLT5cclxuXHRcdFx0XHRjb25zb2xlLmxvZyBcImtleTogI3tjb21tZW50LmtleX0sIHRleHQ6ICN7ZGlhbG9nRGF0YS52YWx1ZX1cIlxyXG5cdFx0XHRcdCNjb21tZW50ID0gXy5maW5kKCRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50cywgKGMpIC0+IGMua2V5ID09IGNvbW1lbnQua2V5KVxyXG5cdFx0XHRcdGNvbW1lbnQudGV4dCA9IGRpYWxvZ0RhdGEudmFsdWVcclxuXHRcdFx0XHRhdXRvU2F2ZSgpXHJcblxyXG5cdFx0IyBmaXggcm91dGluZyBpZiBzb21lb25lIGNvbWVzIGhlcmUgd2l0aCBubyBvciBub24gZXhpc3RpbmcgZG9jaWRcclxuXHRcdGlmICRzdGF0ZVBhcmFtcy5kb2NpZFxyXG5cdFx0XHREYXRhLmRvY3VtZW50KCRzdGF0ZVBhcmFtcy5kb2NpZCkudGhlbiAoZG9jdW1lbnQpIC0+XHJcblx0XHRcdFx0Y29uc29sZS5kaXIgZG9jdW1lbnRcclxuXHRcdFx0XHQkc2NvcGUuY3VycmVudERvY3VtZW50ID0gZG9jdW1lbnRcclxuXHRcdFx0XHQkc2NvcGUuc2VsZWN0Q2hhcHRlcigkc2NvcGUuY3VycmVudERvY3VtZW50LmNoYXB0ZXJzWzBdKVxyXG5cdFx0ZWxzZVxyXG5cdFx0XHQkc3RhdGUuZ28gJ2xpc3QnXHJcbl1cclxuIl19