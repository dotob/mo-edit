(function() {
  var controllers;

  controllers = angular.module('moedit.Controllers');

  controllers.controller('editController', [
    '$scope', '$log', '$q', '$state', '$stateParams', '$window', 'moedit.Socket', 'moedit.SweetAlert', 'moedit.Focus', 'moedit.Data', 'messageCenterService', 'ngDialog', function($scope, $log, $q, $state, $stateParams, $window, Socket, SweetAlert, Focus, Data, messageCenterService, ngDialog) {
      var autoSave, autoSaveCurrentDocument, chapterchange, highlightComment, unhighlightAllComments, unhighlightComment, unselectComments;
      autoSaveCurrentDocument = function() {
        $log.debug("autosave");
        return $scope.saveDocument($scope.currentDocument, "Automatisch gespeichert");
      };
      autoSave = _.debounce(autoSaveCurrentDocument, 5000);
      $scope.selectChapter = function(chapter) {
        var c, _i, _len, _ref;
        $log.info("select chapter " + chapter.title + ":" + chapter.selected);
        unhighlightAllComments();
        unselectComments();
        if ($scope.chapterWatch != null) {
          $scope.chapterWatch();
        }
        $scope.currentChapter = chapter;
        _ref = $scope.currentDocument.chapters;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c._id === chapter._id) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        return $scope.chapterWatch = $scope.$watch('currentChapter.content', chapterchange, true);
      };
      $scope.selectComment = function(comment) {
        var c, _i, _len, _ref;
        unhighlightComment($scope.currentComment);
        $log.info("select comment: " + comment.text + ":" + comment.selected + ":" + comment.key);
        $scope.currentComment = comment;
        _ref = $scope.currentChapter.comments;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c.key === comment.key) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        highlightComment($scope.currentComment);
        return true;
      };
      unselectComments = function() {
        var c, _i, _len, _ref, _ref1, _results;
        if (((_ref = $scope.currentChapter) != null ? _ref.comments : void 0) != null) {
          _ref1 = $scope.currentChapter.comments;
          _results = [];
          for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
            c = _ref1[_i];
            _results.push(c.selected = false);
          }
          return _results;
        }
      };
      highlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).addClass('comment-highlight');
        }
      };
      unhighlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).removeClass('comment-highlight');
        }
      };
      unhighlightAllComments = function() {
        return $(".comment").removeClass('comment-highlight');
      };
      chapterchange = function(newValue, oldValue) {
        var comment, r, removeMe, _i, _j, _len, _len1, _ref;
        $log.debug("changed:: " + $scope.currentChapter.content);
        if (newValue !== oldValue) {
          $scope.currentChapter.lastChanged = new Date();
          if ($scope.commentRemoval) {
            removeMe = [];
            _ref = $scope.currentChapter.comments;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              comment = _ref[_i];
              if (newValue.indexOf(comment.key) < 0) {
                removeMe.push(comment);
              }
            }
            for (_j = 0, _len1 = removeMe.length; _j < _len1; _j++) {
              r = removeMe[_j];
              $scope.deleteComment(r);
            }
            return autoSave();
          }
        }
      };
      $scope.newComment = function(chapter, commentKey) {
        var dialog;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          var comment;
          console.log("key: " + commentKey + ", text: " + dialogData.value);
          comment = {
            author: chance.name(),
            key: commentKey,
            created: new Date(),
            text: dialogData.value
          };
          chapter.lastChanged = new Date();
          chapter.comments.push(comment);
          $scope.selectComment(comment);
          return autoSave();
        });
      };
      $scope.newChapter = function(document) {
        document.chapters.push({
          title: $scope.newChapterTitle,
          author: chance.name(),
          lastChanged: new Date(),
          state: 'ONGOING',
          comments: [],
          version: 1
        });
        $scope.newChapterTitle = '';
        $scope.selectChapter(_.last(document.chapters));
        return autoSave();
      };
      $scope.saveDocument = function(document, msg) {
        if (msg == null) {
          msg = "Gutachten erfolgreich gespeichert";
        }
        return Data.saveDocument(document).then(function(response) {
          if (response.status !== 200) {
            return messageCenterService.add('danger', msg, {
              html: true
            });
          } else {
            return messageCenterService.add('success', msg, {
              timeout: 2000,
              html: true
            });
          }
        });
      };
      $scope.docStateChanged = function(val) {
        return console.log($scope.currentDocument.state);
      };
      $scope.deleteComment = function(comment) {
        var m, r, rgx;
        unhighlightComment(comment);
        rgx = "<span id=\"" + comment.key + "\" class=\".*?\">(.*?)<\/span>";
        console.log("rgx: " + rgx);
        r = new RegExp(rgx);
        console.log("before: " + $scope.currentChapter.content);
        m = $scope.currentChapter.content.match(r);
        console.dir(m);
        $scope.currentChapter.content = $scope.currentChapter.content.replace(r, m[1], 'g');
        console.log("after : " + $scope.currentChapter.content);
        _.remove($scope.currentChapter.comments, function(c) {
          return c.key === comment.key;
        });
        return autoSave();
      };
      $scope.editComment = function(comment) {
        var dialog;
        $scope.newCommentText = comment.text;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          console.log("key: " + comment.key + ", text: " + dialogData.value);
          comment.text = dialogData.value;
          return autoSave();
        });
      };
      if ($stateParams.docid) {
        return Data.document($stateParams.docid).then(function(document) {
          console.dir(document);
          $scope.currentDocument = document;
          return $scope.selectChapter($scope.currentDocument.chapters[0]);
        });
      } else {
        return $state.go('list');
      }
    }
  ]);

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxXQUFBOztBQUFBLEVBQUEsV0FBQSxHQUFjLE9BQU8sQ0FBQyxNQUFSLENBQWdCLG9CQUFoQixDQUFkLENBQUE7O0FBQUEsRUFDQSxXQUFXLENBQUMsVUFBWixDQUF3QixnQkFBeEIsRUFBeUM7SUFDdkMsUUFEdUMsRUFFdkMsTUFGdUMsRUFHdkMsSUFIdUMsRUFJdkMsUUFKdUMsRUFLdkMsY0FMdUMsRUFNdkMsU0FOdUMsRUFPdkMsZUFQdUMsRUFRdkMsbUJBUnVDLEVBU3ZDLGNBVHVDLEVBVXZDLGFBVnVDLEVBV3ZDLHNCQVh1QyxFQVl2QyxVQVp1QyxFQWF4QyxTQUFDLE1BQUQsRUFBUyxJQUFULEVBQWUsRUFBZixFQUFtQixNQUFuQixFQUEyQixZQUEzQixFQUF5QyxPQUF6QyxFQUFrRCxNQUFsRCxFQUEwRCxVQUExRCxFQUFzRSxLQUF0RSxFQUE2RSxJQUE3RSxFQUFtRixvQkFBbkYsRUFBeUcsUUFBekcsR0FBQTtBQUdDLFVBQUEsZ0lBQUE7QUFBQSxNQUFBLHVCQUFBLEdBQTBCLFNBQUEsR0FBQTtBQUN6QixRQUFBLElBQUksQ0FBQyxLQUFMLENBQVksVUFBWixDQUFBLENBQUE7ZUFDQSxNQUFNLENBQUMsWUFBUCxDQUFvQixNQUFNLENBQUMsZUFBM0IsRUFBNkMseUJBQTdDLEVBRnlCO01BQUEsQ0FBMUIsQ0FBQTtBQUFBLE1BSUEsUUFBQSxHQUFXLENBQUMsQ0FBQyxRQUFGLENBQVcsdUJBQVgsRUFBb0MsSUFBcEMsQ0FKWCxDQUFBO0FBQUEsTUFNQSxNQUFNLENBQUMsYUFBUCxHQUF1QixTQUFDLE9BQUQsR0FBQTtBQUN0QixZQUFBLGlCQUFBO0FBQUEsUUFBQSxJQUFJLENBQUMsSUFBTCxDQUFXLGlCQUFBLEdBQWlCLE9BQU8sQ0FBQyxLQUF6QixHQUErQixHQUEvQixHQUFrQyxPQUFPLENBQUMsUUFBckQsQ0FBQSxDQUFBO0FB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QUN0QyxVQUFBLE9BQU8sQ0FBQyxHQUFSLENBQVksUUFBWixDQUFBLENBQUE7QUFBQSxVQUNBLE1BQU0sQ0FBQyxlQUFQLEdBQXlCLFFBRHpCLENBQUE7aUJBRUEsTUFBTSxDQUFDLGFBQVAsQ0FBcUIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxRQUFTLENBQUEsQ0FBQSxDQUFyRCxFQUhzQztRQUFBLENBQXZDLEVBREQ7T0FBQSxNQUFBO2VBTUMsTUFBTSxDQUFDLEVBQVAsQ0FBVyxNQUFYLEVBTkQ7T0EvSEQ7SUFBQSxDQWJ3QztHQUF6QyxDQURBLENBQUE7QUFBQSIsImZpbGUiOiJjb250cm9sbGVycy9lZGl0LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiY29udHJvbGxlcnMgPSBhbmd1bGFyLm1vZHVsZSgnbW9lZGl0LkNvbnRyb2xsZXJzJylcclxuY29udHJvbGxlcnMuY29udHJvbGxlciAnZWRpdENvbnRyb2xsZXInLCBbXHJcblx0JyRzY29wZSdcclxuXHQnJGxvZydcclxuXHQnJHEnXHJcblx0JyRzdGF0ZSdcclxuXHQnJHN0YXRlUGFyYW1zJ1xyXG5cdCckd2luZG93J1xyXG5cdCdtb2VkaXQuU29ja2V0J1xyXG5cdCdtb2VkaXQuU3dlZXRBbGVydCdcclxuXHQnbW9lZGl0LkZvY3VzJ1xyXG5cdCdtb2VkaXQuRGF0YSdcclxuXHQnbWVzc2FnZUNlbnRlclNlcnZpY2UnXHJcblx0J25nRGlhbG9nJ1xyXG5cdCgkc2NvcGUsICRsb2csICRxLCAkc3RhdGUsICRzdGF0ZVBhcmFtcywgJHdpbmRvdywgU29ja2V0LCBTd2VldEFsZXJ0LCBGb2N1cywgRGF0YSwgbWVzc2FnZUNlbnRlclNlcnZpY2UsIG5nRGlhbG9nKSAtPlxyXG5cclxuXHRcdCMgYXV0b3NhdmVcclxuXHRcdGF1dG9TYXZlQ3VycmVudERvY3VtZW50ID0gKCkgLT5cclxuXHRcdFx0JGxvZy5kZWJ1ZyBcImF1dG9zYXZlXCJcclxuXHRcdFx0JHNjb3BlLnNhdmVEb2N1bWVudCgkc2NvcGUuY3VycmVudERvY3VtZW50LCBcIkF1dG9tYXRpc2NoIGdlc3BlaWNoZXJ0XCIpXHJcblx0XHRcclxuXHRcdGF1dG9TYXZlID0gXy5kZWJvdW5jZSBhdXRvU2F2ZUN1cnJlbnREb2N1bWVudCwgNTAwMFxyXG5cclxuXHRcdCRzY29wZS5zZWxlY3RDaGFwdGVyID0gKGNoYXB0ZXIpIC0+XHJcblx0XHRcdCRsb2cuaW5mbyBcInNlbGVjdCBjaGFwdGVyICN7Y2hhcHRlci50aXRsZX06I3tjaGFwdGVyLnNlbGVjdGVkfVwiXHJcblx0XHRcdHVuaGlnaGxpZ2h0QWxsQ29tbWVudHMoKVxyXG5cdFx0XHR1bnNlbGVjdENvbW1lbnRzKClcclxuXHRcdFx0aWYgJHNjb3BlLmNoYXB0ZXJXYXRjaD9cclxuXHRcdFx0XHQkc2NvcGUuY2hhcHRlcldhdGNoKCkgIyByZW1vdmUgd2F0Y2hcclxuXHRcdFx0JHNjb3BlLmN1cnJlbnRDaGFwdGVyID0gY2hhcHRlclxyXG5cdFx0XHRmb3IgYyBpbiAkc2NvcGUuY3VycmVudERvY3VtZW50LmNoYXB0ZXJzXHJcblx0XHRcdFx0aWYgYy5faWQgPT0gY2hhcHRlci5faWRcclxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSB0cnVlXHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IGZhbHNlXHJcblx0XHRcdCRzY29wZS5jaGFwdGVyV2F0Y2ggPSAkc2NvcGUuJHdhdGNoICdjdXJyZW50Q2hhcHRlci5jb250ZW50JywgY2hhcHRlcmNoYW5nZSwgdHJ1ZVxyXG5cclxuXHRcdCRzY29wZS5zZWxlY3RDb21tZW50ID0gKGNvbW1lbnQpIC0+XHJcblx0XHRcdHVuaGlnaGxpZ2h0Q29tbWVudCgkc2NvcGUuY3VycmVudENvbW1lbnQpXHJcblx0XHRcdCRsb2cuaW5mbyBcInNlbGVjdCBjb21tZW50OiAje2NvbW1lbnQudGV4dH06I3tjb21tZW50LnNlbGVjdGVkfToje2NvbW1lbnQua2V5fVwiXHJcblx0XHRcdCRzY29wZS5jdXJyZW50Q29tbWVudCA9IGNvbW1lbnRcclxuXHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXHJcblx0XHRcdFx0aWYgYy5rZXkgPT0gY29tbWVudC5rZXlcclxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSB0cnVlXHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IGZhbHNlXHJcblx0XHRcdGhpZ2hsaWdodENvbW1lbnQoJHNjb3BlLmN1cnJlbnRDb21tZW50KVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZSAjIHRoaXMgaXMgYmVjYXVzZSBhbmd1bGFyIGlzIGNvbXBsYWluZyBhYm91dDogXCJSZWZlcmVuY2luZyBhIERPTSBub2RlIGluIEV4cHJlc3Npb25cIiB3aGVuIGp1c3QgcmV0dXJuaW5nIHNvbWV0aGluZyBlbHNlXHJcblxyXG5cdFx0dW5zZWxlY3RDb21tZW50cyA9ICgpIC0+XHJcblx0XHRcdGlmICRzY29wZS5jdXJyZW50Q2hhcHRlcj8uY29tbWVudHM/XHJcblx0XHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXHJcblx0XHRcdFx0XHRjLnNlbGVjdGVkID0gZmFsc2VcclxuXHJcblx0XHRoaWdobGlnaHRDb21tZW50ID0gKGNvbW1lbnQpIC0+XHJcblx0XHRcdGlmIGNvbW1lbnQ/XHJcblx0XHRcdFx0JChcIiMje2NvbW1lbnQua2V5fVwiKS5hZGRDbGFzcygnY29tbWVudC1oaWdobGlnaHQnKVxyXG5cclxuXHRcdHVuaGlnaGxpZ2h0Q29tbWVudCA9IChjb21tZW50KSAtPlxyXG5cdFx0XHRpZiBjb21tZW50P1xyXG5cdFx0XHRcdCQoXCIjI3tjb21tZW50LmtleX1cIikucmVtb3ZlQ2xhc3MoJ2NvbW1lbnQtaGlnaGxpZ2h0JylcclxuXHJcblx0XHR1bmhpZ2hsaWdodEFsbENvbW1lbnRzID0gKCkgLT5cclxuXHRcdFx0JChcIi5jb21tZW50XCIpLnJlbW92ZUNsYXNzKCdjb21tZW50LWhpZ2hsaWdodCcpXHJcblxyXG5cdFx0Y2hhcHRlcmNoYW5nZSA9IChuZXdWYWx1ZSwgb2xkVmFsdWUpIC0+XHJcblx0XHRcdCRsb2cuZGVidWcgXCJjaGFuZ2VkOjogI3skc2NvcGUuY3VycmVudENoYXB0ZXIuY29udGVudH1cIlxyXG5cdFx0XHRpZiBuZXdWYWx1ZSAhPSBvbGRWYWx1ZVxyXG5cdFx0XHRcdCRzY29wZS5jdXJyZW50Q2hhcHRlci5sYXN0Q2hhbmdlZCA9IG5ldyBEYXRlKClcclxuXHRcdFx0XHRpZiAkc2NvcGUuY29tbWVudFJlbW92YWxcclxuXHRcdFx0XHRcdHJlbW92ZU1lID0gW11cclxuXHRcdFx0XHRcdGZvciBjb21tZW50IGluICRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50c1xyXG5cdFx0XHRcdFx0XHRpZiBuZXdWYWx1ZS5pbmRleE9mKGNvbW1lbnQua2V5KSA8IDBcclxuXHRcdFx0XHRcdFx0XHRyZW1vdmVNZS5wdXNoIGNvbW1lbnRcclxuXHRcdFx0XHRcdGZvciByIGluIHJlbW92ZU1lXHJcblx0XHRcdFx0XHRcdCRzY29wZS5kZWxldGVDb21tZW50IHJcclxuXHRcdFx0XHRcdGF1dG9TYXZlKClcdFxyXG5cclxuXHRcdCRzY29wZS5uZXdDb21tZW50ID0gKGNoYXB0ZXIsIGNvbW1lbnRLZXkpIC0+XHJcblx0XHRcdGRpYWxvZyA9IG5nRGlhbG9nLm9wZW5cclxuXHRcdFx0XHR0ZW1wbGF0ZTogJ2NvbW1lbnQtaW5wdXQtZGlhbG9nJ1xyXG5cdFx0XHRcdHNjb3BlOiAkc2NvcGVcclxuXHRcdFx0ZGlhbG9nLmNsb3NlUHJvbWlzZS50aGVuIChkaWFsb2dEYXRhKSAtPlxyXG5cdFx0XHRcdGNvbnNvbGUubG9nIFwia2V5OiAje2NvbW1lbnRLZXl9LCB0ZXh0OiAje2RpYWxvZ0RhdGEudmFsdWV9XCJcclxuXHRcdFx0XHRjb21tZW50ID0gXHJcblx0XHRcdFx0XHRhdXRob3I6IGNoYW5jZS5uYW1lKClcclxuXHRcdFx0XHRcdGtleTogY29tbWVudEtleVxyXG5cdFx0XHRcdFx0Y3JlYXRlZDogbmV3IERhdGUoKVxyXG5cdFx0XHRcdFx0dGV4dDogZGlhbG9nRGF0YS52YWx1ZVxyXG5cdFx0XHRcdGNoYXB0ZXIubGFzdENoYW5nZWQgPSBuZXcgRGF0ZSgpXHJcblx0XHRcdFx0Y2hhcHRlci5jb21tZW50cy5wdXNoIGNvbW1lbnRcclxuXHRcdFx0XHQkc2NvcGUuc2VsZWN0Q29tbWVudCBjb21tZW50XHJcblx0XHRcdFx0YXV0b1NhdmUoKVxyXG5cclxuXHRcdCRzY29wZS5uZXdDaGFwdGVyID0gKGRvY3VtZW50KSAtPlxyXG5cdFx0XHRkb2N1bWVudC5jaGFwdGVycy5wdXNoXHJcblx0XHRcdFx0dGl0bGU6ICRzY29wZS5uZXdDaGFwdGVyVGl0bGVcclxuXHRcdFx0XHRhdXRob3I6IGNoYW5jZS5uYW1lKClcclxuXHRcdFx0XHRsYXN0Q2hhbmdlZDogbmV3IERhdGUoKVxyXG5cdFx0XHRcdHN0YXRlOiAnT05HT0lORydcclxuXHRcdFx0XHRjb21tZW50czogW11cclxuXHRcdFx0XHR2ZXJzaW9uOiAxXHJcblx0XHRcdCRzY29wZS5uZXdDaGFwdGVyVGl0bGUgPSAnJ1xyXG5cdFx0XHQkc2NvcGUuc2VsZWN0Q2hhcHRlcihfLmxhc3QgZG9jdW1lbnQuY2hhcHRlcnMpXHJcblx0XHRcdGF1dG9TYXZlKClcclxuXHJcblx0XHQkc2NvcGUuc2F2ZURvY3VtZW50ID0gKGRvY3VtZW50LCBtc2cgPSBcIkd1dGFjaHRlbiBlcmZvbGdyZWljaCBnZXNwZWljaGVydFwiKSAtPlxyXG5cdFx0XHREYXRhLnNhdmVEb2N1bWVudChkb2N1bWVudCkudGhlbiAocmVzcG9uc2UpIC0+XHJcblx0XHRcdFx0aWYgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMFxyXG5cdFx0XHRcdFx0bWVzc2FnZUNlbnRlclNlcnZpY2UuYWRkKCdkYW5nZXInLCBtc2csIHtodG1sOiB0cnVlfSk7XHJcblx0XHRcdFx0ZWxzZVxyXG5cdFx0XHRcdFx0bWVzc2FnZUNlbnRlclNlcnZpY2UuYWRkKCdzdWNjZXNzJywgbXNnLCB7dGltZW91dDogMjAwMCwgaHRtbDogdHJ1ZX0pO1xyXG5cclxuXHRcdCRzY29wZS5kb2NTdGF0ZUNoYW5nZWQgPSAodmFsKSAtPlxyXG5cdFx0XHRjb25zb2xlLmxvZyAkc2NvcGUuY3VycmVudERvY3VtZW50LnN0YXRlXHJcblxyXG5cdFx0JHNjb3BlLmRlbGV0ZUNvbW1lbnQgPSAoY29tbWVudCkgLT5cclxuXHRcdFx0dW5oaWdobGlnaHRDb21tZW50KGNvbW1lbnQpXHJcblx0XHRcdHJneCA9IFwiPHNwYW4gaWQ9XFxcIiN7Y29tbWVudC5rZXl9XFxcIiBjbGFzcz1cXFwiLio/XFxcIj4oLio/KTxcXC9zcGFuPlwiXHJcblx0XHRcdGNvbnNvbGUubG9nIFwicmd4OiAje3JneH1cIlxyXG5cdFx0XHRyID0gbmV3IFJlZ0V4cCByZ3hcclxuXHRcdFx0Y29uc29sZS5sb2cgXCJiZWZvcmU6ICN7JHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbnRlbnR9XCJcclxuXHRcdFx0bSA9ICRzY29wZS5jdXJyZW50Q2hhcHRlci5jb250ZW50Lm1hdGNoIHJcclxuXHRcdFx0Y29uc29sZS5kaXIgbVxyXG5cdFx0XHQkc2NvcGUuY3VycmVudENoYXB0ZXIuY29udGVudCA9ICRzY29wZS5jdXJyZW50Q2hhcHRlci5jb250ZW50LnJlcGxhY2UgciwgbVsxXSwgJ2cnXHJcblx0XHRcdGNvbnNvbGUubG9nIFwiYWZ0ZXIgOiAjeyRzY29wZS5jdXJyZW50Q2hhcHRlci5jb250ZW50fVwiXHJcblx0XHRcdF8ucmVtb3ZlKCRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50cywgKGMpIC0+IGMua2V5ID09IGNvbW1lbnQua2V5KVxyXG5cdFx0XHRhdXRvU2F2ZSgpXHJcblxyXG5cdFx0JHNjb3BlLmVkaXRDb21tZW50ID0gKGNvbW1lbnQpIC0+IFxyXG5cdFx0XHQkc2NvcGUubmV3Q29tbWVudFRleHQgPSBjb21tZW50LnRleHRcclxuXHRcdFx0ZGlhbG9nID0gbmdEaWFsb2cub3BlblxyXG5cdFx0XHRcdHRlbXBsYXRlOiAnY29tbWVudC1pbnB1dC1kaWFsb2cnXHJcblx0XHRcdFx0c2NvcGU6ICRzY29wZVxyXG5cdFx0XHRkaWFsb2cuY2xvc2VQcm9taXNlLnRoZW4gKGRpYWxvZ0RhdGEpIC0+XHJcblx0XHRcdFx0Y29uc29sZS5sb2cgXCJrZXk6ICN7Y29tbWVudC5rZXl9LCB0ZXh0OiAje2RpYWxvZ0RhdGEudmFsdWV9XCJcclxuXHRcdFx0XHQjY29tbWVudCA9IF8uZmluZCgkc2NvcGUuY3VycmVudENoYXB0ZXIuY29tbWVudHMsIChjKSAtPiBjLmtleSA9PSBjb21tZW50LmtleSlcclxuXHRcdFx0XHRjb21tZW50LnRleHQgPSBkaWFsb2dEYXRhLnZhbHVlXHJcblx0XHRcdFx0YXV0b1NhdmUoKVxyXG5cclxuXHRcdCMgZml4IHJvdXRpbmcgaWYgc29tZW9uZSBjb21lcyBoZXJlIHdpdGggbm8gb3Igbm9uIGV4aXN0aW5nIGRvY2lkXHJcblx0XHRpZiAkc3RhdGVQYXJhbXMuZG9jaWRcclxuXHRcdFx0RGF0YS5kb2N1bWVudCgkc3RhdGVQYXJhbXMuZG9jaWQpLnRoZW4gKGRvY3VtZW50KSAtPlxyXG5cdFx0XHRcdGNvbnNvbGUuZGlyIGRvY3VtZW50XHJcblx0XHRcdFx0JHNjb3BlLmN1cnJlbnREb2N1bWVudCA9IGRvY3VtZW50XHJcblx0XHRcdFx0JHNjb3BlLnNlbGVjdENoYXB0ZXIoJHNjb3BlLmN1cnJlbnREb2N1bWVudC5jaGFwdGVyc1swXSlcclxuXHRcdGVsc2VcclxuXHRcdFx0JHN0YXRlLmdvICdsaXN0J1xyXG5dXHJcbiJdfQ==