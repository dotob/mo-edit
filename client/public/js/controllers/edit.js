(function() {
  var controllers;

  controllers = angular.module('moedit.Controllers');

  controllers.controller('editController', [
    '$scope', '$log', '$q', '$state', '$stateParams', '$window', 'moedit.Socket', 'moedit.SweetAlert', 'moedit.Focus', 'moedit.Data', 'messageCenterService', 'ngDialog', function($scope, $log, $q, $state, $stateParams, $window, Socket, SweetAlert, Focus, Data, messageCenterService, ngDialog) {
      var autoSave, autoSaveCurrentDocument, chapterchange, highlightComment, unhighlightAllComments, unhighlightComment;
      autoSaveCurrentDocument = function() {
        $log.debug("autosave");
        return $scope.saveDocument($scope.currentDocument, "Automatisch gespeichert");
      };
      autoSave = _.debounce(autoSaveCurrentDocument, 5000);
      $scope.selectChapter = function(chapter) {
        var c, _i, _len, _ref;
        unhighlightAllComments();
        if ($scope.chapterWatch != null) {
          $scope.chapterWatch();
        }
        $log.info("select chapter " + chapter.title + ":" + chapter.selected);
        $scope.currentChapter = chapter;
        _ref = $scope.currentDocument.chapters;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c._id === chapter._id) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        return $scope.chapterWatch = $scope.$watch('currentChapter.content', chapterchange, true);
      };
      $scope.selectComment = function(comment) {
        var c, _i, _len, _ref;
        unhighlightComment($scope.currentComment);
        $log.info("select comment: " + comment.text + ":" + comment.selected);
        $scope.currentComment = comment;
        _ref = $scope.currentChapter.comments;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c.key === comment.key) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        return highlightComment($scope.currentComment);
      };
      highlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).addClass('comment-highlight');
        }
      };
      unhighlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).removeClass('comment-highlight');
        }
      };
      unhighlightAllComments = function() {
        return $(".comment").removeClass('comment-highlight');
      };
      chapterchange = function(newValue, oldValue) {
        var comment, r, removeMe, _i, _j, _len, _len1, _ref;
        $log.debug("changed");
        console.log($scope.currentChapter.content);
        if (newValue !== oldValue) {
          $scope.currentChapter.lastChanged = new Date();
          removeMe = [];
          _ref = $scope.currentChapter.comments;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            comment = _ref[_i];
            if (newValue.indexOf(comment.key) < 0) {
              removeMe.push(comment);
            }
          }
          for (_j = 0, _len1 = removeMe.length; _j < _len1; _j++) {
            r = removeMe[_j];
            deleteComment(r);
          }
          return autoSave();
        }
      };
      $scope.newComment = function(chapter) {
        var comment;
        comment = {
          author: chance.name(),
          key: chance.guid(),
          created: new Date()
        };
        chapter.comments.push(comment);
        autoSave();
        return comment;
      };
      $scope.getCommentText = function(chapter, commentKey) {
        var dialog;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          var comment;
          console.log("key: " + commentKey + ", text: " + dialogData.value);
          comment = _.find(chapter.comments, function(c) {
            return c.key === commentKey;
          });
          comment.text = dialogData.value;
          return autoSave();
        });
      };
      $scope.newChapter = function(document) {
        document.chapters.push({
          title: $scope.newChapterTitle,
          author: chance.name(),
          lastChanged: new Date(),
          state: 'ONGOING',
          comments: [],
          version: 1
        });
        $scope.newChapterTitle = '';
        $scope.selectChapter(_.last(document.chapters));
        return autoSave();
      };
      $scope.saveDocument = function(document, msg) {
        if (msg == null) {
          msg = "Gutachten erfolgreich gespeichert";
        }
        return Data.saveDocument(document).then(function(response) {
          if (response.status !== 200) {
            return messageCenterService.add('danger', msg, {
              html: true
            });
          } else {
            return messageCenterService.add('success', msg, {
              timeout: 2000,
              html: true
            });
          }
        });
      };
      $scope.docStateChanged = function(val) {
        return console.log($scope.currentDocument.state);
      };
      $scope.deleteComment = function(comment) {
        var r;
        unhighlightComment(comment);
        r = new RegExp("<span id=\"" + comment.key + "\" class=\".*?\">");
        comment.text.replace(r, '', 'g');
        _.remove($scope.currentChapter.comments, function(c) {
          return c.key === comment.key;
        });
        return autoSave();
      };
      $scope.editComment = function(comment) {
        var dialog;
        $scope.newCommentText = comment.text;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          console.log("key: " + comment.key + ", text: " + dialogData.value);
          comment.text = dialogData.value;
          return autoSave();
        });
      };
      if ($stateParams.docid) {
        return Data.document($stateParams.docid).then(function(document) {
          console.dir(document);
          $scope.currentDocument = document;
          return $scope.selectChapter($scope.currentDocument.chapters[0]);
        });
      } else {
        return $state.go('list');
      }
    }
  ]);

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxXQUFBOztBQUFBLEVBQUEsV0FBQSxHQUFjLE9BQU8sQ0FBQyxNQUFSLENBQWdCLG9CQUFoQixDQUFkLENBQUE7O0FBQUEsRUFDQSxXQUFXLENBQUMsVUFBWixDQUF3QixnQkFBeEIsRUFBeUM7SUFDdkMsUUFEdUMsRUFFdkMsTUFGdUMsRUFHdkMsSUFIdUMsRUFJdkMsUUFKdUMsRUFLdkMsY0FMdUMsRUFNdkMsU0FOdUMsRUFPdkMsZUFQdUMsRUFRdkMsbUJBUnVDLEVBU3ZDLGNBVHVDLEVBVXZDLGFBVnVDLEVBV3ZDLHNCQVh1QyxFQVl2QyxVQVp1QyxFQWF4QyxTQUFDLE1BQUQsRUFBUyxJQUFULEVBQWUsRUFBZixFQUFtQixNQUFuQixFQUEyQixZQUEzQixFQUF5QyxPQUF6QyxFQUFrRCxNQUFsRCxFQUEwRCxVQUExRCxFQUFzRSxLQUF0RSxFQUE2RSxJQUE3RSxFQUFtRixvQkFBbkYsRUFBeUcsUUFBekcsR0FBQTtBQUdDLFVBQUEsOEdBQUE7QUFBQSxNQUFBLHVCQUFBLEdBQTBCLFNBQUEsR0FBQTtBQUN6QixRQUFBLElBQUksQ0FBQyxLQUFMLENBQVksVUFBWixDQUFBLENBQUE7ZUFDQSxNQUFNLENBQUMsWUFBUCxDQUFvQixNQUFNLENBQUMsZUFBM0IsRUFBNkMseUJBQTdDLEVBRnlCO01BQUEsQ0FBMUIsQ0FBQTtBQUFBLE1BSUEsUUFBQSxHQUFXLENBQUMsQ0FBQyxRQUFGLENBQVcsdUJBQVgsRUFBb0MsSUFBcEMsQ0FKWCxDQUFBO0FBQUEsTUFNQSxNQUFNLENBQUMsYUFBUCxHQUF1QixTQUFDLE9BQUQsR0FBQTtBQUN0QixZQUFBLGlCQUFBO0FBQUEsUUFBQSxzQkFBQSxDQUFBLENBQUEsQ0FBQTtBQUNBLFFBQUEsSUFBRywyQkFBSDtBQUNDLFVBQUEsTUFBTSxDQUFDLFlBQVAsQ0FBQSxDQUFBLENBREQ7U0FEQTtBQUFBLFFB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VCxDQUFBO2VBSUEsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFwQixDQUF5QixTQUFDLFVBQUQsR0FBQTtBQUN4QixVQUFBLE9BQU8sQ0FBQyxHQUFSLENBQWEsT0FBQSxHQUFPLE9BQU8sQ0FBQyxHQUFmLEdBQW1CLFVBQW5CLEdBQTZCLFVBQVUsQ0FBQyxLQUFyRCxDQUFBLENBQUE7QUFBQSxVQUVBLE9BQU8sQ0FBQyxJQUFSLEdBQWUsVUFBVSxDQUFDLEtBRjFCLENBQUE7aUJBR0EsUUFBQSxDQUFBLEVBSndCO1FBQUEsQ0FBekIsRUFMb0I7TUFBQSxDQXRHckIsQ0FBQTtBQWtIQSxNQUFBLElBQUcsWUFBWSxDQUFDLEtBQWhCO2VBQ0MsSUFBSSxDQUFDLFFBQUwsQ0FBYyxZQUFZLENBQUMsS0FBM0IsQ0FBaUMsQ0FBQyxJQUFsQyxDQUF1QyxTQUFDLFFBQUQsR0FBQTtBQUN0QyxVQUFBLE9BQU8sQ0FBQyxHQUFSLENBQVksUUFBWixDQUFBLENBQUE7QUFBQSxVQUNBLE1BQU0sQ0FBQyxlQUFQLEdBQXlCLFFBRHpCLENBQUE7aUJBRUEsTUFBTSxDQUFDLGFBQVAsQ0FBcUIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxRQUFTLENBQUEsQ0FBQSxDQUFyRCxFQUhzQztRQUFBLENBQXZDLEVBREQ7T0FBQSxNQUFBO2VBTUMsTUFBTSxDQUFDLEVBQVAsQ0FBVyxNQUFYLEVBTkQ7T0FySEQ7SUFBQSxDQWJ3QztHQUF6QyxDQURBLENBQUE7QUFBQSIsImZpbGUiOiJjb250cm9sbGVycy9lZGl0LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiY29udHJvbGxlcnMgPSBhbmd1bGFyLm1vZHVsZSgnbW9lZGl0LkNvbnRyb2xsZXJzJylcbmNvbnRyb2xsZXJzLmNvbnRyb2xsZXIgJ2VkaXRDb250cm9sbGVyJywgW1xuXHQnJHNjb3BlJ1xuXHQnJGxvZydcblx0JyRxJ1xuXHQnJHN0YXRlJ1xuXHQnJHN0YXRlUGFyYW1zJ1xuXHQnJHdpbmRvdydcblx0J21vZWRpdC5Tb2NrZXQnXG5cdCdtb2VkaXQuU3dlZXRBbGVydCdcblx0J21vZWRpdC5Gb2N1cydcblx0J21vZWRpdC5EYXRhJ1xuXHQnbWVzc2FnZUNlbnRlclNlcnZpY2UnXG5cdCduZ0RpYWxvZydcblx0KCRzY29wZSwgJGxvZywgJHEsICRzdGF0ZSwgJHN0YXRlUGFyYW1zLCAkd2luZG93LCBTb2NrZXQsIFN3ZWV0QWxlcnQsIEZvY3VzLCBEYXRhLCBtZXNzYWdlQ2VudGVyU2VydmljZSwgbmdEaWFsb2cpIC0+XG5cblx0XHQjIGF1dG9zYXZlXG5cdFx0YXV0b1NhdmVDdXJyZW50RG9jdW1lbnQgPSAoKSAtPlxuXHRcdFx0JGxvZy5kZWJ1ZyBcImF1dG9zYXZlXCJcblx0XHRcdCRzY29wZS5zYXZlRG9jdW1lbnQoJHNjb3BlLmN1cnJlbnREb2N1bWVudCwgXCJBdXRvbWF0aXNjaCBnZXNwZWljaGVydFwiKVxuXHRcdFxuXHRcdGF1dG9TYXZlID0gXy5kZWJvdW5jZSBhdXRvU2F2ZUN1cnJlbnREb2N1bWVudCwgNTAwMFxuXG5cdFx0JHNjb3BlLnNlbGVjdENoYXB0ZXIgPSAoY2hhcHRlcikgLT5cblx0XHRcdHVuaGlnaGxpZ2h0QWxsQ29tbWVudHMoKVxuXHRcdFx0aWYgJHNjb3BlLmNoYXB0ZXJXYXRjaD9cblx0XHRcdFx0JHNjb3BlLmNoYXB0ZXJXYXRjaCgpICMgcmVtb3ZlIHdhdGNoXG5cdFx0XHQkbG9nLmluZm8gXCJzZWxlY3QgY2hhcHRlciAje2NoYXB0ZXIudGl0bGV9OiN7Y2hhcHRlci5zZWxlY3RlZH1cIlxuXHRcdFx0JHNjb3BlLmN1cnJlbnRDaGFwdGVyID0gY2hhcHRlclxuXHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnREb2N1bWVudC5jaGFwdGVyc1xuXHRcdFx0XHRpZiBjLl9pZCA9PSBjaGFwdGVyLl9pZFxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSB0cnVlXG5cdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHRjLnNlbGVjdGVkID0gZmFsc2Vcblx0XHRcdCRzY29wZS5jaGFwdGVyV2F0Y2ggPSAkc2NvcGUuJHdhdGNoICdjdXJyZW50Q2hhcHRlci5jb250ZW50JywgY2hhcHRlcmNoYW5nZSwgdHJ1ZVxuXG5cdFx0JHNjb3BlLnNlbGVjdENvbW1lbnQgPSAoY29tbWVudCkgLT5cblx0XHRcdHVuaGlnaGxpZ2h0Q29tbWVudCgkc2NvcGUuY3VycmVudENvbW1lbnQpXG5cdFx0XHQkbG9nLmluZm8gXCJzZWxlY3QgY29tbWVudDogI3tjb21tZW50LnRleHR9OiN7Y29tbWVudC5zZWxlY3RlZH1cIlxuXHRcdFx0JHNjb3BlLmN1cnJlbnRDb21tZW50ID0gY29tbWVudFxuXHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXG5cdFx0XHRcdGlmIGMua2V5ID09IGNvbW1lbnQua2V5XG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IHRydWVcblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSBmYWxzZVxuXHRcdFx0aGlnaGxpZ2h0Q29tbWVudCgkc2NvcGUuY3VycmVudENvbW1lbnQpXG5cblx0XHRoaWdobGlnaHRDb21tZW50ID0gKGNvbW1lbnQpIC0+XG5cdFx0XHRpZiBjb21tZW50P1xuXHRcdFx0XHQkKFwiIyN7Y29tbWVudC5rZXl9XCIpLmFkZENsYXNzKCdjb21tZW50LWhpZ2hsaWdodCcpXG5cblx0XHR1bmhpZ2hsaWdodENvbW1lbnQgPSAoY29tbWVudCkgLT5cblx0XHRcdGlmIGNvbW1lbnQ/XG5cdFx0XHRcdCQoXCIjI3tjb21tZW50LmtleX1cIikucmVtb3ZlQ2xhc3MoJ2NvbW1lbnQtaGlnaGxpZ2h0JylcblxuXHRcdHVuaGlnaGxpZ2h0QWxsQ29tbWVudHMgPSAoKSAtPlxuXHRcdFx0JChcIi5jb21tZW50XCIpLnJlbW92ZUNsYXNzKCdjb21tZW50LWhpZ2hsaWdodCcpXG5cblx0XHRjaGFwdGVyY2hhbmdlID0gKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgLT5cblx0XHRcdCRsb2cuZGVidWcgXCJjaGFuZ2VkXCJcblx0XHRcdGNvbnNvbGUubG9nICRzY29wZS5jdXJyZW50Q2hhcHRlci5jb250ZW50XG5cdFx0XHRpZiBuZXdWYWx1ZSAhPSBvbGRWYWx1ZVxuXHRcdFx0XHQkc2NvcGUuY3VycmVudENoYXB0ZXIubGFzdENoYW5nZWQgPSBuZXcgRGF0ZSgpXG5cdFx0XHRcdHJlbW92ZU1lID0gW11cblx0XHRcdFx0Zm9yIGNvbW1lbnQgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXG5cdFx0XHRcdFx0aWYgbmV3VmFsdWUuaW5kZXhPZihjb21tZW50LmtleSkgPCAwXG5cdFx0XHRcdFx0XHRyZW1vdmVNZS5wdXNoIGNvbW1lbnRcblx0XHRcdFx0Zm9yIHIgaW4gcmVtb3ZlTWVcblx0XHRcdFx0XHRkZWxldGVDb21tZW50IHJcblx0XHRcdFx0YXV0b1NhdmUoKVx0XG5cblx0XHQkc2NvcGUubmV3Q29tbWVudCA9IChjaGFwdGVyKSAtPlxuXHRcdFx0Y29tbWVudCA9IFxuXHRcdFx0XHRhdXRob3I6IGNoYW5jZS5uYW1lKClcblx0XHRcdFx0a2V5OiBjaGFuY2UuZ3VpZCgpXG5cdFx0XHRcdGNyZWF0ZWQ6IG5ldyBEYXRlKClcblx0XHRcdGNoYXB0ZXIuY29tbWVudHMucHVzaCBjb21tZW50XG5cdFx0XHRhdXRvU2F2ZSgpXG5cdFx0XHRjb21tZW50XG5cblx0XHQkc2NvcGUuZ2V0Q29tbWVudFRleHQgPSAoY2hhcHRlciwgY29tbWVudEtleSkgLT5cblx0XHRcdGRpYWxvZyA9IG5nRGlhbG9nLm9wZW5cblx0XHRcdFx0dGVtcGxhdGU6ICdjb21tZW50LWlucHV0LWRpYWxvZydcblx0XHRcdFx0c2NvcGU6ICRzY29wZVxuXHRcdFx0ZGlhbG9nLmNsb3NlUHJvbWlzZS50aGVuIChkaWFsb2dEYXRhKSAtPlxuXHRcdFx0XHRjb25zb2xlLmxvZyBcImtleTogI3tjb21tZW50S2V5fSwgdGV4dDogI3tkaWFsb2dEYXRhLnZhbHVlfVwiXG5cdFx0XHRcdGNvbW1lbnQgPSBfLmZpbmQoY2hhcHRlci5jb21tZW50cywgKGMpIC0+IGMua2V5ID09IGNvbW1lbnRLZXkpXG5cdFx0XHRcdGNvbW1lbnQudGV4dCA9IGRpYWxvZ0RhdGEudmFsdWVcblx0XHRcdFx0YXV0b1NhdmUoKVxuXG5cdFx0JHNjb3BlLm5ld0NoYXB0ZXIgPSAoZG9jdW1lbnQpIC0+XG5cdFx0XHRkb2N1bWVudC5jaGFwdGVycy5wdXNoXG5cdFx0XHRcdHRpdGxlOiAkc2NvcGUubmV3Q2hhcHRlclRpdGxlXG5cdFx0XHRcdGF1dGhvcjogY2hhbmNlLm5hbWUoKVxuXHRcdFx0XHRsYXN0Q2hhbmdlZDogbmV3IERhdGUoKVxuXHRcdFx0XHRzdGF0ZTogJ09OR09JTkcnXG5cdFx0XHRcdGNvbW1lbnRzOiBbXVxuXHRcdFx0XHR2ZXJzaW9uOiAxXG5cdFx0XHQkc2NvcGUubmV3Q2hhcHRlclRpdGxlID0gJydcblx0XHRcdCRzY29wZS5zZWxlY3RDaGFwdGVyKF8ubGFzdCBkb2N1bWVudC5jaGFwdGVycylcblx0XHRcdGF1dG9TYXZlKClcblxuXHRcdCRzY29wZS5zYXZlRG9jdW1lbnQgPSAoZG9jdW1lbnQsIG1zZyA9IFwiR3V0YWNodGVuIGVyZm9sZ3JlaWNoIGdlc3BlaWNoZXJ0XCIpIC0+XG5cdFx0XHREYXRhLnNhdmVEb2N1bWVudChkb2N1bWVudCkudGhlbiAocmVzcG9uc2UpIC0+XG5cdFx0XHRcdGlmIHJlc3BvbnNlLnN0YXR1cyAhPSAyMDBcblx0XHRcdFx0XHRtZXNzYWdlQ2VudGVyU2VydmljZS5hZGQoJ2RhbmdlcicsIG1zZywge2h0bWw6IHRydWV9KTtcblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdG1lc3NhZ2VDZW50ZXJTZXJ2aWNlLmFkZCgnc3VjY2VzcycsIG1zZywge3RpbWVvdXQ6IDIwMDAsIGh0bWw6IHRydWV9KTtcblxuXHRcdCRzY29wZS5kb2NTdGF0ZUNoYW5nZWQgPSAodmFsKSAtPlxuXHRcdFx0Y29uc29sZS5sb2cgJHNjb3BlLmN1cnJlbnREb2N1bWVudC5zdGF0ZVxuXG5cdFx0JHNjb3BlLmRlbGV0ZUNvbW1lbnQgPSAoY29tbWVudCkgLT5cblx0XHRcdHVuaGlnaGxpZ2h0Q29tbWVudChjb21tZW50KVxuXHRcdFx0ciA9IG5ldyBSZWdFeHAgXCI8c3BhbiBpZD1cXFwiI3tjb21tZW50LmtleX1cXFwiIGNsYXNzPVxcXCIuKj9cXFwiPlwiXG5cdFx0XHRjb21tZW50LnRleHQucmVwbGFjZSByLCAnJywgJ2cnXG5cdFx0XHRfLnJlbW92ZSgkc2NvcGUuY3VycmVudENoYXB0ZXIuY29tbWVudHMsIChjKSAtPiBjLmtleSA9PSBjb21tZW50LmtleSlcblx0XHRcdGF1dG9TYXZlKClcblxuXHRcdCRzY29wZS5lZGl0Q29tbWVudCA9IChjb21tZW50KSAtPiBcblx0XHRcdCRzY29wZS5uZXdDb21tZW50VGV4dCA9IGNvbW1lbnQudGV4dFxuXHRcdFx0ZGlhbG9nID0gbmdEaWFsb2cub3BlblxuXHRcdFx0XHR0ZW1wbGF0ZTogJ2NvbW1lbnQtaW5wdXQtZGlhbG9nJ1xuXHRcdFx0XHRzY29wZTogJHNjb3BlXG5cdFx0XHRkaWFsb2cuY2xvc2VQcm9taXNlLnRoZW4gKGRpYWxvZ0RhdGEpIC0+XG5cdFx0XHRcdGNvbnNvbGUubG9nIFwia2V5OiAje2NvbW1lbnQua2V5fSwgdGV4dDogI3tkaWFsb2dEYXRhLnZhbHVlfVwiXG5cdFx0XHRcdCNjb21tZW50ID0gXy5maW5kKCRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50cywgKGMpIC0+IGMua2V5ID09IGNvbW1lbnQua2V5KVxuXHRcdFx0XHRjb21tZW50LnRleHQgPSBkaWFsb2dEYXRhLnZhbHVlXG5cdFx0XHRcdGF1dG9TYXZlKClcblxuXHRcdCMgZml4IHJvdXRpbmcgaWYgc29tZW9uZSBjb21lcyBoZXJlIHdpdGggbm8gb3Igbm9uIGV4aXN0aW5nIGRvY2lkXG5cdFx0aWYgJHN0YXRlUGFyYW1zLmRvY2lkXG5cdFx0XHREYXRhLmRvY3VtZW50KCRzdGF0ZVBhcmFtcy5kb2NpZCkudGhlbiAoZG9jdW1lbnQpIC0+XG5cdFx0XHRcdGNvbnNvbGUuZGlyIGRvY3VtZW50XG5cdFx0XHRcdCRzY29wZS5jdXJyZW50RG9jdW1lbnQgPSBkb2N1bWVudFxuXHRcdFx0XHQkc2NvcGUuc2VsZWN0Q2hhcHRlcigkc2NvcGUuY3VycmVudERvY3VtZW50LmNoYXB0ZXJzWzBdKVxuXHRcdGVsc2Vcblx0XHRcdCRzdGF0ZS5nbyAnbGlzdCdcbl1cbiJdfQ==