(function() {
  var controllers;

  controllers = angular.module('moedit.Controllers');

  controllers.controller('editController', [
    '$scope', '$log', '$q', '$state', '$stateParams', '$window', 'moedit.Socket', 'moedit.SweetAlert', 'moedit.Focus', 'moedit.Data', 'messageCenterService', 'ngDialog', function($scope, $log, $q, $state, $stateParams, $window, Socket, SweetAlert, Focus, Data, messageCenterService, ngDialog) {
      var autoSave, autoSaveCurrentDocument, chapterchange, highlightComment, unhighlightAllComments, unhighlightComment, unselectComments;
      autoSaveCurrentDocument = function() {
        $log.debug("autosave");
        return $scope.saveDocument($scope.currentDocument, "Automatisch gespeichert");
      };
      autoSave = _.debounce(autoSaveCurrentDocument, 5000);
      $scope.selectChapter = function(chapter) {
        var c, i, len, ref;
        $log.info("select chapter " + chapter.title + ":" + chapter.selected);
        unhighlightAllComments();
        unselectComments();
        if ($scope.chapterWatch != null) {
          $scope.chapterWatch();
        }
        $scope.currentChapter = chapter;
        ref = $scope.currentDocument.chapters;
        for (i = 0, len = ref.length; i < len; i++) {
          c = ref[i];
          if (c._id === chapter._id) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        return $scope.chapterWatch = $scope.$watch('currentChapter.content', chapterchange, true);
      };
      $scope.selectComment = function(comment) {
        var c, i, len, ref;
        unhighlightComment($scope.currentComment);
        $log.info("select comment: " + comment.text + ":" + comment.selected + ":" + comment.key);
        $scope.currentComment = comment;
        ref = $scope.currentChapter.comments;
        for (i = 0, len = ref.length; i < len; i++) {
          c = ref[i];
          if (c.key === comment.key) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        highlightComment($scope.currentComment);
        return true;
      };
      unselectComments = function() {
        var c, i, len, ref, ref1, results;
        if (((ref = $scope.currentChapter) != null ? ref.comments : void 0) != null) {
          ref1 = $scope.currentChapter.comments;
          results = [];
          for (i = 0, len = ref1.length; i < len; i++) {
            c = ref1[i];
            results.push(c.selected = false);
          }
          return results;
        }
      };
      highlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).addClass('comment-highlight');
        }
      };
      unhighlightComment = function(comment) {
        if (comment != null) {
          return $("#" + comment.key).removeClass('comment-highlight');
        }
      };
      unhighlightAllComments = function() {
        return $(".comment").removeClass('comment-highlight');
      };
      chapterchange = function(newValue, oldValue) {
        var comment, i, j, len, len1, r, ref, removeMe;
        $log.debug("changed:: " + $scope.currentChapter.content);
        if (newValue !== oldValue) {
          $scope.currentChapter.lastChanged = new Date();
          if ($scope.commentRemoval) {
            removeMe = [];
            ref = $scope.currentChapter.comments;
            for (i = 0, len = ref.length; i < len; i++) {
              comment = ref[i];
              if (newValue.indexOf(comment.key) < 0) {
                removeMe.push(comment);
              }
            }
            for (j = 0, len1 = removeMe.length; j < len1; j++) {
              r = removeMe[j];
              $scope.deleteComment(r);
            }
            return autoSave();
          }
        }
      };
      $scope.newComment = function(chapter, commentKey) {
        var dialog;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          var comment;
          console.log("key: " + commentKey + ", text: " + dialogData.value);
          comment = {
            author: chance.name(),
            key: commentKey,
            created: new Date(),
            text: dialogData.value
          };
          chapter.lastChanged = new Date();
          chapter.comments.push(comment);
          $scope.selectComment(comment);
          return autoSave();
        });
      };
      $scope.newChapter = function(document) {
        document.chapters.push({
          title: $scope.newChapterTitle,
          author: chance.name(),
          lastChanged: new Date(),
          state: 'ONGOING',
          comments: [],
          version: 1
        });
        $scope.newChapterTitle = '';
        $scope.selectChapter(_.last(document.chapters));
        return autoSave();
      };
      $scope.saveDocument = function(document, msg) {
        if (msg == null) {
          msg = "Gutachten erfolgreich gespeichert";
        }
        return Data.saveDocument(document).then(function(response) {
          if (response.status !== 200) {
            return messageCenterService.add('danger', msg, {
              html: true
            });
          } else {
            return messageCenterService.add('success', msg, {
              timeout: 2000,
              html: true
            });
          }
        });
      };
      $scope.docStateChanged = function(val) {
        return console.log($scope.currentDocument.state);
      };
      $scope.deleteComment = function(comment) {
        var m, r, rgx;
        unhighlightComment(comment);
        rgx = "<span id=\"" + comment.key + "\" class=\".*?\">(.*?)<\/span>";
        console.log("rgx: " + rgx);
        r = new RegExp(rgx);
        console.log("before: " + $scope.currentChapter.content);
        m = $scope.currentChapter.content.match(r);
        console.dir(m);
        $scope.currentChapter.content = $scope.currentChapter.content.replace(r, m[1], 'g');
        console.log("after : " + $scope.currentChapter.content);
        _.remove($scope.currentChapter.comments, function(c) {
          return c.key === comment.key;
        });
        return autoSave();
      };
      $scope.editComment = function(comment) {
        var dialog;
        $scope.newCommentText = comment.text;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(dialogData) {
          console.log("key: " + comment.key + ", text: " + dialogData.value);
          comment.text = dialogData.value;
          return autoSave();
        });
      };
      $scope.newVersion = function(document) {
        var newDoc;
        newDoc = angular.copy(document);
        delete newDoc._id;
        newDoc.version++;
        return $scope.saveDocument(newDoc, "Neue Version gespeichert");
      };
      if ($stateParams.docid) {
        return Data.document($stateParams.docid).then(function(document) {
          console.dir(document);
          $scope.currentDocument = document;
          return $scope.selectChapter($scope.currentDocument.chapters[0]);
        });
      } else {
        return $state.go('list');
      }
    }
  ]);

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxXQUFBOztBQUFBLEVBQUEsV0FBQSxHQUFjLE9BQU8sQ0FBQyxNQUFSLENBQWUsb0JBQWYsQ0FBZCxDQUFBOztBQUFBLEVBQ0EsV0FBVyxDQUFDLFVBQVosQ0FBdUIsZ0JBQXZCLEVBQXlDO0lBQ3hDLFFBRHdDLEVBRXhDLE1BRndDLEVBR3hDLElBSHdDLEVBSXhDLFFBSndDLEVBS3hDLGNBTHdDLEVBTXhDLFNBTndDLEVBT3hDLGVBUHdDLEVBUXhDLG1CQVJ3QyxFQVN4QyxjQVR3QyxFQVV4QyxhQVZ3QyxFQVd4QyxzQkFYd0MsRUFZeEMsVUFad0MsRUFheEMsU0FBQyxNQUFELEVBQVMsSUFBVCxFQUFlLEVBQWYsRUFBbUIsTUFBbkIsRUFBMkIsWUFBM0IsRUFBeUMsT0FBekMsRUFBa0QsTUFBbEQsRUFBMEQsVUFBMUQsRUFBc0UsS0FBdEUsRUFBNkUsSUFBN0UsRUFBbUYsb0JBQW5GLEVBQXlHLFFBQXpHLEdBQUE7QUFHQyxVQUFBLGdJQUFBO0FBQUEsTUFBQSx1QkFBQSxHQUEwQixTQUFBLEdBQUE7QUFDekIsUUFBQSxJQUFJLENBQUMsS0FBTCxDQUFXLFVBQVgsQ0FBQSxDQUFBO2VBQ0EsTUFBTSxDQUFDLFlBQVAsQ0FBb0IsTUFBTSxDQUFDLGVBQTNCLEVBQTRDLHlCQUE1QyxFQUZ5QjtNQUFBLENBQTFCLENBQUE7QUFBQSxNQUlBLFFBQUEsR0FBVyxDQUFDLENBQUMsUUFBRixDQUFXLHVCQUFYLEVBQW9DLElBQXBDLENBSlgsQ0FBQTtBQUFBLE1BTUEsTUFBTSxDQUFDLGFBQVAsR0FBdUIsU0FBQyxPQUFELEdBQUE7QUFDdEIsWUFBQSxjQUFBO0FBQUEsUUFBQSxJQUFJLENBQUMsSUFBTCxDQUFVLGlCQUFBLEdBQWtCLE9BQU8sQ0FBQyxLQUExQixHQUFnQyxHQUFoQyxHQUFtQyxPQUFPLENBQUMsUUFBckQsQ0FBQSxDQUFBO0FBQUEs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QUE7QUFBQSxRQUNBLE1BQUEsQ0FBQSxNQUFhLENBQUMsR0FEZCxDQUFBO0FBQUEsUUFFQSxNQUFNLENBQUMsT0FBUCxFQUZBLENBQUE7ZUFHQSxNQUFNLENBQUMsWUFBUCxDQUFvQixNQUFwQixFQUE0QiwwQkFBNUIsRUFKbUI7TUFBQSxDQTNIcEIsQ0FBQTtBQWtJQSxNQUFBLElBQUcsWUFBWSxDQUFDLEtBQWhCO2VBQ0MsSUFBSSxDQUFDLFFBQUwsQ0FBYyxZQUFZLENBQUMsS0FBM0IsQ0FBaUMsQ0FBQyxJQUFsQyxDQUF1QyxTQUFDLFFBQUQsR0FBQTtBQUN0QyxVQUFBLE9BQU8sQ0FBQyxHQUFSLENBQVksUUFBWixDQUFBLENBQUE7QUFBQSxVQUNBLE1BQU0sQ0FBQyxlQUFQLEdBQXlCLFFBRHpCLENBQUE7aUJBRUEsTUFBTSxDQUFDLGFBQVAsQ0FBcUIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxRQUFTLENBQUEsQ0FBQSxDQUFyRCxFQUhzQztRQUFBLENBQXZDLEVBREQ7T0FBQSxNQUFBO2VBTUMsTUFBTSxDQUFDLEVBQVAsQ0FBVSxNQUFWLEVBTkQ7T0FySUQ7SUFBQSxDQWJ3QztHQUF6QyxDQURBLENBQUE7QUFBQSIsImZpbGUiOiJjb250cm9sbGVycy9lZGl0LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiY29udHJvbGxlcnMgPSBhbmd1bGFyLm1vZHVsZSgnbW9lZGl0LkNvbnRyb2xsZXJzJylcbmNvbnRyb2xsZXJzLmNvbnRyb2xsZXIgJ2VkaXRDb250cm9sbGVyJywgW1xuXHQnJHNjb3BlJ1xuXHQnJGxvZydcblx0JyRxJ1xuXHQnJHN0YXRlJ1xuXHQnJHN0YXRlUGFyYW1zJ1xuXHQnJHdpbmRvdydcblx0J21vZWRpdC5Tb2NrZXQnXG5cdCdtb2VkaXQuU3dlZXRBbGVydCdcblx0J21vZWRpdC5Gb2N1cydcblx0J21vZWRpdC5EYXRhJ1xuXHQnbWVzc2FnZUNlbnRlclNlcnZpY2UnXG5cdCduZ0RpYWxvZydcblx0KCRzY29wZSwgJGxvZywgJHEsICRzdGF0ZSwgJHN0YXRlUGFyYW1zLCAkd2luZG93LCBTb2NrZXQsIFN3ZWV0QWxlcnQsIEZvY3VzLCBEYXRhLCBtZXNzYWdlQ2VudGVyU2VydmljZSwgbmdEaWFsb2cpIC0+XG5cblx0XHQjIGF1dG9zYXZlXG5cdFx0YXV0b1NhdmVDdXJyZW50RG9jdW1lbnQgPSAoKSAtPlxuXHRcdFx0JGxvZy5kZWJ1ZyBcImF1dG9zYXZlXCJcblx0XHRcdCRzY29wZS5zYXZlRG9jdW1lbnQoJHNjb3BlLmN1cnJlbnREb2N1bWVudCwgXCJBdXRvbWF0aXNjaCBnZXNwZWljaGVydFwiKVxuXHRcdFxuXHRcdGF1dG9TYXZlID0gXy5kZWJvdW5jZSBhdXRvU2F2ZUN1cnJlbnREb2N1bWVudCwgNTAwMFxuXG5cdFx0JHNjb3BlLnNlbGVjdENoYXB0ZXIgPSAoY2hhcHRlcikgLT5cblx0XHRcdCRsb2cuaW5mbyBcInNlbGVjdCBjaGFwdGVyICN7Y2hhcHRlci50aXRsZX06I3tjaGFwdGVyLnNlbGVjdGVkfVwiXG5cdFx0XHR1bmhpZ2hsaWdodEFsbENvbW1lbnRzKClcblx0XHRcdHVuc2VsZWN0Q29tbWVudHMoKVxuXHRcdFx0aWYgJHNjb3BlLmNoYXB0ZXJXYXRjaD9cblx0XHRcdFx0JHNjb3BlLmNoYXB0ZXJXYXRjaCgpICMgcmVtb3ZlIHdhdGNoXG5cdFx0XHQkc2NvcGUuY3VycmVudENoYXB0ZXIgPSBjaGFwdGVyXG5cdFx0XHRmb3IgYyBpbiAkc2NvcGUuY3VycmVudERvY3VtZW50LmNoYXB0ZXJzXG5cdFx0XHRcdGlmIGMuX2lkID09IGNoYXB0ZXIuX2lkXG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IHRydWVcblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSBmYWxzZVxuXHRcdFx0JHNjb3BlLmNoYXB0ZXJXYXRjaCA9ICRzY29wZS4kd2F0Y2ggJ2N1cnJlbnRDaGFwdGVyLmNvbnRlbnQnLCBjaGFwdGVyY2hhbmdlLCB0cnVlXG5cblx0XHQkc2NvcGUuc2VsZWN0Q29tbWVudCA9IChjb21tZW50KSAtPlxuXHRcdFx0dW5oaWdobGlnaHRDb21tZW50KCRzY29wZS5jdXJyZW50Q29tbWVudClcblx0XHRcdCRsb2cuaW5mbyBcInNlbGVjdCBjb21tZW50OiAje2NvbW1lbnQudGV4dH06I3tjb21tZW50LnNlbGVjdGVkfToje2NvbW1lbnQua2V5fVwiXG5cdFx0XHQkc2NvcGUuY3VycmVudENvbW1lbnQgPSBjb21tZW50XG5cdFx0XHRmb3IgYyBpbiAkc2NvcGUuY3VycmVudENoYXB0ZXIuY29tbWVudHNcblx0XHRcdFx0aWYgYy5rZXkgPT0gY29tbWVudC5rZXlcblx0XHRcdFx0XHRjLnNlbGVjdGVkID0gdHJ1ZVxuXHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IGZhbHNlXG5cdFx0XHRoaWdobGlnaHRDb21tZW50KCRzY29wZS5jdXJyZW50Q29tbWVudClcblx0XHRcdHJldHVybiB0cnVlICMgdGhpcyBpcyBiZWNhdXNlIGFuZ3VsYXIgaXMgY29tcGxhaW5nIGFib3V0OiBcIlJlZmVyZW5jaW5nIGEgRE9NIG5vZGUgaW4gRXhwcmVzc2lvblwiIHdoZW4ganVzdCByZXR1cm5pbmcgc29tZXRoaW5nIGVsc2VcblxuXHRcdHVuc2VsZWN0Q29tbWVudHMgPSAoKSAtPlxuXHRcdFx0aWYgJHNjb3BlLmN1cnJlbnRDaGFwdGVyPy5jb21tZW50cz9cblx0XHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IGZhbHNlXG5cblx0XHRoaWdobGlnaHRDb21tZW50ID0gKGNvbW1lbnQpIC0+XG5cdFx0XHRpZiBjb21tZW50P1xuXHRcdFx0XHQkKFwiIyN7Y29tbWVudC5rZXl9XCIpLmFkZENsYXNzKCdjb21tZW50LWhpZ2hsaWdodCcpXG5cblx0XHR1bmhpZ2hsaWdodENvbW1lbnQgPSAoY29tbWVudCkgLT5cblx0XHRcdGlmIGNvbW1lbnQ/XG5cdFx0XHRcdCQoXCIjI3tjb21tZW50LmtleX1cIikucmVtb3ZlQ2xhc3MoJ2NvbW1lbnQtaGlnaGxpZ2h0JylcblxuXHRcdHVuaGlnaGxpZ2h0QWxsQ29tbWVudHMgPSAoKSAtPlxuXHRcdFx0JChcIi5jb21tZW50XCIpLnJlbW92ZUNsYXNzKCdjb21tZW50LWhpZ2hsaWdodCcpXG5cblx0XHRjaGFwdGVyY2hhbmdlID0gKG5ld1ZhbHVlLCBvbGRWYWx1ZSkgLT5cblx0XHRcdCRsb2cuZGVidWcgXCJjaGFuZ2VkOjogI3skc2NvcGUuY3VycmVudENoYXB0ZXIuY29udGVudH1cIlxuXHRcdFx0aWYgbmV3VmFsdWUgIT0gb2xkVmFsdWVcblx0XHRcdFx0JHNjb3BlLmN1cnJlbnRDaGFwdGVyLmxhc3RDaGFuZ2VkID0gbmV3IERhdGUoKVxuXHRcdFx0XHRpZiAkc2NvcGUuY29tbWVudFJlbW92YWxcblx0XHRcdFx0XHRyZW1vdmVNZSA9IFtdXG5cdFx0XHRcdFx0Zm9yIGNvbW1lbnQgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXG5cdFx0XHRcdFx0XHRpZiBuZXdWYWx1ZS5pbmRleE9mKGNvbW1lbnQua2V5KSA8IDBcblx0XHRcdFx0XHRcdFx0cmVtb3ZlTWUucHVzaCBjb21tZW50XG5cdFx0XHRcdFx0Zm9yIHIgaW4gcmVtb3ZlTWVcblx0XHRcdFx0XHRcdCRzY29wZS5kZWxldGVDb21tZW50IHJcblx0XHRcdFx0XHRhdXRvU2F2ZSgpXHRcblxuXHRcdCRzY29wZS5uZXdDb21tZW50ID0gKGNoYXB0ZXIsIGNvbW1lbnRLZXkpIC0+XG5cdFx0XHRkaWFsb2cgPSBuZ0RpYWxvZy5vcGVuXG5cdFx0XHRcdHRlbXBsYXRlOiAnY29tbWVudC1pbnB1dC1kaWFsb2cnXG5cdFx0XHRcdHNjb3BlOiAkc2NvcGVcblx0XHRcdGRpYWxvZy5jbG9zZVByb21pc2UudGhlbiAoZGlhbG9nRGF0YSkgLT5cblx0XHRcdFx0Y29uc29sZS5sb2cgXCJrZXk6ICN7Y29tbWVudEtleX0sIHRleHQ6ICN7ZGlhbG9nRGF0YS52YWx1ZX1cIlxuXHRcdFx0XHRjb21tZW50ID0gXG5cdFx0XHRcdFx0YXV0aG9yOiBjaGFuY2UubmFtZSgpXG5cdFx0XHRcdFx0a2V5OiBjb21tZW50S2V5XG5cdFx0XHRcdFx0Y3JlYXRlZDogbmV3IERhdGUoKVxuXHRcdFx0XHRcdHRleHQ6IGRpYWxvZ0RhdGEudmFsdWVcblx0XHRcdFx0Y2hhcHRlci5sYXN0Q2hhbmdlZCA9IG5ldyBEYXRlKClcblx0XHRcdFx0Y2hhcHRlci5jb21tZW50cy5wdXNoIGNvbW1lbnRcblx0XHRcdFx0JHNjb3BlLnNlbGVjdENvbW1lbnQgY29tbWVudFxuXHRcdFx0XHRhdXRvU2F2ZSgpXG5cblx0XHQkc2NvcGUubmV3Q2hhcHRlciA9IChkb2N1bWVudCkgLT5cblx0XHRcdGRvY3VtZW50LmNoYXB0ZXJzLnB1c2hcblx0XHRcdFx0dGl0bGU6ICRzY29wZS5uZXdDaGFwdGVyVGl0bGVcblx0XHRcdFx0YXV0aG9yOiBjaGFuY2UubmFtZSgpXG5cdFx0XHRcdGxhc3RDaGFuZ2VkOiBuZXcgRGF0ZSgpXG5cdFx0XHRcdHN0YXRlOiAnT05HT0lORydcblx0XHRcdFx0Y29tbWVudHM6IFtdXG5cdFx0XHRcdHZlcnNpb246IDFcblx0XHRcdCRzY29wZS5uZXdDaGFwdGVyVGl0bGUgPSAnJ1xuXHRcdFx0JHNjb3BlLnNlbGVjdENoYXB0ZXIoXy5sYXN0IGRvY3VtZW50LmNoYXB0ZXJzKVxuXHRcdFx0YXV0b1NhdmUoKVxuXG5cdFx0JHNjb3BlLnNhdmVEb2N1bWVudCA9IChkb2N1bWVudCwgbXNnID0gXCJHdXRhY2h0ZW4gZXJmb2xncmVpY2ggZ2VzcGVpY2hlcnRcIikgLT5cblx0XHRcdERhdGEuc2F2ZURvY3VtZW50KGRvY3VtZW50KS50aGVuIChyZXNwb25zZSkgLT5cblx0XHRcdFx0aWYgcmVzcG9uc2Uuc3RhdHVzICE9IDIwMFxuXHRcdFx0XHRcdG1lc3NhZ2VDZW50ZXJTZXJ2aWNlLmFkZCgnZGFuZ2VyJywgbXNnLCB7aHRtbDogdHJ1ZX0pO1xuXHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0bWVzc2FnZUNlbnRlclNlcnZpY2UuYWRkKCdzdWNjZXNzJywgbXNnLCB7dGltZW91dDogMjAwMCwgaHRtbDogdHJ1ZX0pO1xuXG5cdFx0JHNjb3BlLmRvY1N0YXRlQ2hhbmdlZCA9ICh2YWwpIC0+XG5cdFx0XHRjb25zb2xlLmxvZyAkc2NvcGUuY3VycmVudERvY3VtZW50LnN0YXRlXG5cblx0XHQkc2NvcGUuZGVsZXRlQ29tbWVudCA9IChjb21tZW50KSAtPlxuXHRcdFx0dW5oaWdobGlnaHRDb21tZW50KGNvbW1lbnQpXG5cdFx0XHRyZ3ggPSBcIjxzcGFuIGlkPVxcXCIje2NvbW1lbnQua2V5fVxcXCIgY2xhc3M9XFxcIi4qP1xcXCI+KC4qPyk8XFwvc3Bhbj5cIlxuXHRcdFx0Y29uc29sZS5sb2cgXCJyZ3g6ICN7cmd4fVwiXG5cdFx0XHRyID0gbmV3IFJlZ0V4cCByZ3hcblx0XHRcdGNvbnNvbGUubG9nIFwiYmVmb3JlOiAjeyRzY29wZS5jdXJyZW50Q2hhcHRlci5jb250ZW50fVwiXG5cdFx0XHRtID0gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbnRlbnQubWF0Y2ggclxuXHRcdFx0Y29uc29sZS5kaXIgbVxuXHRcdFx0JHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbnRlbnQgPSAkc2NvcGUuY3VycmVudENoYXB0ZXIuY29udGVudC5yZXBsYWNlIHIsIG1bMV0sICdnJ1xuXHRcdFx0Y29uc29sZS5sb2cgXCJhZnRlciA6ICN7JHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbnRlbnR9XCJcblx0XHRcdF8ucmVtb3ZlKCRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50cywgKGMpIC0+IGMua2V5ID09IGNvbW1lbnQua2V5KVxuXHRcdFx0YXV0b1NhdmUoKVxuXG5cdFx0JHNjb3BlLmVkaXRDb21tZW50ID0gKGNvbW1lbnQpIC0+IFxuXHRcdFx0JHNjb3BlLm5ld0NvbW1lbnRUZXh0ID0gY29tbWVudC50ZXh0XG5cdFx0XHRkaWFsb2cgPSBuZ0RpYWxvZy5vcGVuXG5cdFx0XHRcdHRlbXBsYXRlOiAnY29tbWVudC1pbnB1dC1kaWFsb2cnXG5cdFx0XHRcdHNjb3BlOiAkc2NvcGVcblx0XHRcdGRpYWxvZy5jbG9zZVByb21pc2UudGhlbiAoZGlhbG9nRGF0YSkgLT5cblx0XHRcdFx0Y29uc29sZS5sb2cgXCJrZXk6ICN7Y29tbWVudC5rZXl9LCB0ZXh0OiAje2RpYWxvZ0RhdGEudmFsdWV9XCJcblx0XHRcdFx0I2NvbW1lbnQgPSBfLmZpbmQoJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzLCAoYykgLT4gYy5rZXkgPT0gY29tbWVudC5rZXkpXG5cdFx0XHRcdGNvbW1lbnQudGV4dCA9IGRpYWxvZ0RhdGEudmFsdWVcblx0XHRcdFx0YXV0b1NhdmUoKVxuXG5cdFx0JHNjb3BlLm5ld1ZlcnNpb24gPSAoZG9jdW1lbnQpIC0+XG5cdFx0XHRuZXdEb2MgPSBhbmd1bGFyLmNvcHkgZG9jdW1lbnRcblx0XHRcdGRlbGV0ZSBuZXdEb2MuX2lkXG5cdFx0XHRuZXdEb2MudmVyc2lvbisrXG5cdFx0XHQkc2NvcGUuc2F2ZURvY3VtZW50IG5ld0RvYywgXCJOZXVlIFZlcnNpb24gZ2VzcGVpY2hlcnRcIlxuXG5cdFx0IyBmaXggcm91dGluZyBpZiBzb21lb25lIGNvbWVzIGhlcmUgd2l0aCBubyBvciBub24gZXhpc3RpbmcgZG9jaWRcblx0XHRpZiAkc3RhdGVQYXJhbXMuZG9jaWRcblx0XHRcdERhdGEuZG9jdW1lbnQoJHN0YXRlUGFyYW1zLmRvY2lkKS50aGVuIChkb2N1bWVudCkgLT5cblx0XHRcdFx0Y29uc29sZS5kaXIgZG9jdW1lbnRcblx0XHRcdFx0JHNjb3BlLmN1cnJlbnREb2N1bWVudCA9IGRvY3VtZW50XG5cdFx0XHRcdCRzY29wZS5zZWxlY3RDaGFwdGVyKCRzY29wZS5jdXJyZW50RG9jdW1lbnQuY2hhcHRlcnNbMF0pXG5cdFx0ZWxzZVxuXHRcdFx0JHN0YXRlLmdvICdsaXN0J1xuXVxuIl19