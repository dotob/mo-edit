(function() {
  var controllers;

  controllers = angular.module('moedit.Controllers');

  controllers.controller('editController', [
    '$scope', '$log', '$q', '$state', '$stateParams', '$window', 'moedit.Socket', 'moedit.SweetAlert', 'moedit.Focus', 'moedit.Data', 'messageCenterService', 'ngDialog', function($scope, $log, $q, $state, $stateParams, $window, Socket, SweetAlert, Focus, Data, messageCenterService, ngDialog) {
      var autoSave, autoSaveCurrentDocument, chapterchange;
      autoSaveCurrentDocument = function() {
        $log.debug("autosave");
        return $scope.saveDocument($scope.currentDocument, "Automatisch gespeichert");
      };
      autoSave = _.debounce(autoSaveCurrentDocument, 5000);
      $scope.selectChapter = function(chapter) {
        var c, _i, _len, _ref;
        if ($scope.chapterWatch != null) {
          $scope.chapterWatch();
        }
        $log.info("select chapter " + chapter.title + ":" + chapter.selected);
        $scope.currentChapter = chapter;
        _ref = $scope.currentDocument.chapters;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c._id === chapter._id) {
            c.selected = true;
          } else {
            c.selected = false;
          }
        }
        return $scope.chapterWatch = $scope.$watch('currentChapter.content', chapterchange, true);
      };
      $scope.selectComment = function(comment) {
        var c, _i, _len, _ref, _results;
        $log.info("select comment " + comment.text + ":" + comment.selected);
        $scope.currentComment = comment;
        _ref = $scope.currentChapter.comments;
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          c = _ref[_i];
          if (c.key === comment.key) {
            _results.push(c.selected = true);
          } else {
            _results.push(c.selected = false);
          }
        }
        return _results;
      };
      chapterchange = function(newValue, oldValue) {
        var comment, r, removeMe, _i, _j, _len, _len1, _ref;
        $log.debug("changed");
        console.log($scope.currentChapter.content);
        if (newValue !== oldValue) {
          $scope.currentChapter.lastChanged = new Date();
          removeMe = [];
          _ref = $scope.currentChapter.comments;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            comment = _ref[_i];
            if (newValue.indexOf(comment.key) < 0) {
              removeMe.push(comment.key);
            }
          }
          for (_j = 0, _len1 = removeMe.length; _j < _len1; _j++) {
            r = removeMe[_j];
            _.remove($scope.currentChapter.comments, function(c) {
              return c.key === r;
            });
          }
          return autoSave();
        }
      };
      $scope.newComment = function(chapter) {
        var comment;
        comment = {
          author: chance.name(),
          key: chance.guid(),
          created: new Date()
        };
        chapter.comments.push(comment);
        autoSave();
        return comment;
      };
      $scope.getCommentText = function(chapter, commentKey) {
        var dialog;
        dialog = ngDialog.open({
          template: 'comment-input-dialog',
          scope: $scope
        });
        return dialog.closePromise.then(function(tmp) {
          var comment;
          console.log("key: " + commentKey + ", text: " + $scope.newCommentText);
          comment = _.find(chapter.comments, function(c) {
            return c.key === commentKey;
          });
          comment.text = $scope.newCommentText;
          return autoSave();
        });
      };
      $scope.newChapter = function(document) {
        document.chapters.push({
          title: $scope.newChapterTitle,
          author: chance.name(),
          lastChanged: new Date(),
          state: 'ONGOING',
          comments: [],
          version: 1
        });
        $scope.newChapterTitle = '';
        $scope.selectChapter(_.last(document.chapters));
        return autoSave();
      };
      $scope.saveDocument = function(document, msg) {
        if (msg == null) {
          msg = "Gutachten erfolgreich gespeichert";
        }
        return Data.saveDocument(document).then(function(response) {
          if (response.status !== 200) {
            return messageCenterService.add('danger', msg, {
              html: true
            });
          } else {
            return messageCenterService.add('success', msg, {
              timeout: 2000,
              html: true
            });
          }
        });
      };
      $scope.docStateChanged = function(val) {
        return console.log($scope.currentDocument.state);
      };
      if ($stateParams.docid) {
        return Data.document($stateParams.docid).then(function(document) {
          console.dir(document);
          $scope.currentDocument = document;
          return $scope.selectChapter($scope.currentDocument.chapters[0]);
        });
      } else {
        return $state.go('list');
      }
    }
  ]);

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbnRyb2xsZXJzL2VkaXQuY29mZmVlIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQUEsTUFBQSxXQUFBOztBQUFBLEVBQUEsV0FBQSxHQUFjLE9BQU8sQ0FBQyxNQUFSLENBQWdCLG9CQUFoQixDQUFkLENBQUE7O0FBQUEsRUFDQSxXQUFXLENBQUMsVUFBWixDQUF3QixnQkFBeEIsRUFBeUM7SUFDdkMsUUFEdUMsRUFFdkMsTUFGdUMsRUFHdkMsSUFIdUMsRUFJdkMsUUFKdUMsRUFLdkMsY0FMdUMsRUFNdkMsU0FOdUMsRUFPdkMsZUFQdUMsRUFRdkMsbUJBUnVDLEVBU3ZDLGNBVHVDLEVBVXZDLGFBVnVDLEVBV3ZDLHNCQVh1QyxFQVl2QyxVQVp1QyxFQWF4QyxTQUFDLE1BQUQsRUFBUyxJQUFULEVBQWUsRUFBZixFQUFtQixNQUFuQixFQUEyQixZQUEzQixFQUF5QyxPQUF6QyxFQUFrRCxNQUFsRCxFQUEwRCxVQUExRCxFQUFzRSxLQUF0RSxFQUE2RSxJQUE3RSxFQUFtRixvQkFBbkYsRUFBeUcsUUFBekcsR0FBQTtBQUdDLFVBQUEsZ0RBQUE7QUFBQSxNQUFBLHVCQUFBLEdBQTBCLFNBQUEsR0FBQTtBQUN6QixRQUFBLElBQUksQ0FBQyxLQUFMLENBQVksVUFBWixDQUFBLENBQUE7ZUFDQSxNQUFNLENBQUMsWUFBUCxDQUFvQixNQUFNLENBQUMsZUFBM0IsRUFBNkMseUJBQTdDLEVBRnlCO01BQUEsQ0FBMUIsQ0FBQTtBQUFBLE1BSUEsUUFBQSxHQUFXLENBQUMsQ0FBQyxRQUFGLENBQVcsdUJBQVgsRUFBb0MsSUFBcEMsQ0FKWCxDQUFBO0FBQUEsTUFNQSxNQUFNLENBQUMsYUFBUCxHQUF1QixTQUFDLE9BQUQsR0FBQTtBQUN0QixZQUFBLGlCQUFBO0FBQUEsUUFBQSxJQUFHLDJCQUFIO0FBQ0MsVUFBQSxNQUFNLENBQUMsWUFBUCxDQUFBLENBQUEsQ0FERDtTQUFBO0FBQUEsUUFFQSxJQUFJLENBQUMsSUFBTCxDQUFXLGlCQUFBLEdB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QU0sQ0FBQyxhQUFQLENBQXFCLE1BQU0sQ0FBQyxlQUFlLENBQUMsUUFBUyxDQUFBLENBQUEsQ0FBckQsRUFIc0M7UUFBQSxDQUF2QyxFQUREO09BQUEsTUFBQTtlQU1DLE1BQU0sQ0FBQyxFQUFQLENBQVcsTUFBWCxFQU5EO09BcEZEO0lBQUEsQ0Fid0M7R0FBekMsQ0FEQSxDQUFBO0FBQUEiLCJmaWxlIjoiY29udHJvbGxlcnMvZWRpdC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImNvbnRyb2xsZXJzID0gYW5ndWxhci5tb2R1bGUoJ21vZWRpdC5Db250cm9sbGVycycpXG5jb250cm9sbGVycy5jb250cm9sbGVyICdlZGl0Q29udHJvbGxlcicsIFtcblx0JyRzY29wZSdcblx0JyRsb2cnXG5cdCckcSdcblx0JyRzdGF0ZSdcblx0JyRzdGF0ZVBhcmFtcydcblx0JyR3aW5kb3cnXG5cdCdtb2VkaXQuU29ja2V0J1xuXHQnbW9lZGl0LlN3ZWV0QWxlcnQnXG5cdCdtb2VkaXQuRm9jdXMnXG5cdCdtb2VkaXQuRGF0YSdcblx0J21lc3NhZ2VDZW50ZXJTZXJ2aWNlJ1xuXHQnbmdEaWFsb2cnXG5cdCgkc2NvcGUsICRsb2csICRxLCAkc3RhdGUsICRzdGF0ZVBhcmFtcywgJHdpbmRvdywgU29ja2V0LCBTd2VldEFsZXJ0LCBGb2N1cywgRGF0YSwgbWVzc2FnZUNlbnRlclNlcnZpY2UsIG5nRGlhbG9nKSAtPlxuXG5cdFx0IyBhdXRvc2F2ZVxuXHRcdGF1dG9TYXZlQ3VycmVudERvY3VtZW50ID0gKCkgLT5cblx0XHRcdCRsb2cuZGVidWcgXCJhdXRvc2F2ZVwiXG5cdFx0XHQkc2NvcGUuc2F2ZURvY3VtZW50KCRzY29wZS5jdXJyZW50RG9jdW1lbnQsIFwiQXV0b21hdGlzY2ggZ2VzcGVpY2hlcnRcIilcblx0XHRcblx0XHRhdXRvU2F2ZSA9IF8uZGVib3VuY2UgYXV0b1NhdmVDdXJyZW50RG9jdW1lbnQsIDUwMDBcblxuXHRcdCRzY29wZS5zZWxlY3RDaGFwdGVyID0gKGNoYXB0ZXIpIC0+XG5cdFx0XHRpZiAkc2NvcGUuY2hhcHRlcldhdGNoP1xuXHRcdFx0XHQkc2NvcGUuY2hhcHRlcldhdGNoKCkgIyByZW1vdmUgd2F0Y2hcblx0XHRcdCRsb2cuaW5mbyBcInNlbGVjdCBjaGFwdGVyICN7Y2hhcHRlci50aXRsZX06I3tjaGFwdGVyLnNlbGVjdGVkfVwiXG5cdFx0XHQkc2NvcGUuY3VycmVudENoYXB0ZXIgPSBjaGFwdGVyXG5cdFx0XHRmb3IgYyBpbiAkc2NvcGUuY3VycmVudERvY3VtZW50LmNoYXB0ZXJzXG5cdFx0XHRcdGlmIGMuX2lkID09IGNoYXB0ZXIuX2lkXG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IHRydWVcblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSBmYWxzZVxuXHRcdFx0JHNjb3BlLmNoYXB0ZXJXYXRjaCA9ICRzY29wZS4kd2F0Y2ggJ2N1cnJlbnRDaGFwdGVyLmNvbnRlbnQnLCBjaGFwdGVyY2hhbmdlLCB0cnVlXG5cblx0XHQkc2NvcGUuc2VsZWN0Q29tbWVudCA9IChjb21tZW50KSAtPlxuXHRcdFx0JGxvZy5pbmZvIFwic2VsZWN0IGNvbW1lbnQgI3tjb21tZW50LnRleHR9OiN7Y29tbWVudC5zZWxlY3RlZH1cIlxuXHRcdFx0JHNjb3BlLmN1cnJlbnRDb21tZW50ID0gY29tbWVudFxuXHRcdFx0Zm9yIGMgaW4gJHNjb3BlLmN1cnJlbnRDaGFwdGVyLmNvbW1lbnRzXG5cdFx0XHRcdGlmIGMua2V5ID09IGNvbW1lbnQua2V5XG5cdFx0XHRcdFx0Yy5zZWxlY3RlZCA9IHRydWVcblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdGMuc2VsZWN0ZWQgPSBmYWxzZVxuXG5cdFx0Y2hhcHRlcmNoYW5nZSA9IChuZXdWYWx1ZSwgb2xkVmFsdWUpIC0+XG5cdFx0XHQkbG9nLmRlYnVnIFwiY2hhbmdlZFwiXG5cdFx0XHRjb25zb2xlLmxvZyAkc2NvcGUuY3VycmVudENoYXB0ZXIuY29udGVudFxuXHRcdFx0aWYgbmV3VmFsdWUgIT0gb2xkVmFsdWVcblx0XHRcdFx0JHNjb3BlLmN1cnJlbnRDaGFwdGVyLmxhc3RDaGFuZ2VkID0gbmV3IERhdGUoKVxuXHRcdFx0XHRyZW1vdmVNZSA9IFtdXG5cdFx0XHRcdGZvciBjb21tZW50IGluICRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50c1xuXHRcdFx0XHRcdGlmIG5ld1ZhbHVlLmluZGV4T2YoY29tbWVudC5rZXkpIDwgMFxuXHRcdFx0XHRcdFx0cmVtb3ZlTWUucHVzaCBjb21tZW50LmtleVxuXHRcdFx0XHRmb3IgciBpbiByZW1vdmVNZVxuXHRcdFx0XHRcdF8ucmVtb3ZlKCRzY29wZS5jdXJyZW50Q2hhcHRlci5jb21tZW50cywgKGMpIC0+IGMua2V5ID09IHIpXG5cdFx0XHRcdGF1dG9TYXZlKClcdFxuXG5cdFx0JHNjb3BlLm5ld0NvbW1lbnQgPSAoY2hhcHRlcikgLT5cblx0XHRcdGNvbW1lbnQgPSBcblx0XHRcdFx0YXV0aG9yOiBjaGFuY2UubmFtZSgpXG5cdFx0XHRcdGtleTogY2hhbmNlLmd1aWQoKVxuXHRcdFx0XHRjcmVhdGVkOiBuZXcgRGF0ZSgpXG5cdFx0XHRjaGFwdGVyLmNvbW1lbnRzLnB1c2ggY29tbWVudFxuXHRcdFx0YXV0b1NhdmUoKVxuXHRcdFx0Y29tbWVudFxuXG5cdFx0JHNjb3BlLmdldENvbW1lbnRUZXh0ID0gKGNoYXB0ZXIsIGNvbW1lbnRLZXkpIC0+XG5cdFx0XHRkaWFsb2cgPSBuZ0RpYWxvZy5vcGVuXG5cdFx0XHRcdHRlbXBsYXRlOiAnY29tbWVudC1pbnB1dC1kaWFsb2cnXG5cdFx0XHRcdHNjb3BlOiAkc2NvcGVcblx0XHRcdGRpYWxvZy5jbG9zZVByb21pc2UudGhlbiAodG1wKSAtPlxuXHRcdFx0XHRjb25zb2xlLmxvZyBcImtleTogI3tjb21tZW50S2V5fSwgdGV4dDogI3skc2NvcGUubmV3Q29tbWVudFRleHR9XCJcblx0XHRcdFx0Y29tbWVudCA9IF8uZmluZChjaGFwdGVyLmNvbW1lbnRzLCAoYykgLT4gYy5rZXkgPT0gY29tbWVudEtleSlcblx0XHRcdFx0Y29tbWVudC50ZXh0ID0gJHNjb3BlLm5ld0NvbW1lbnRUZXh0XG5cdFx0XHRcdGF1dG9TYXZlKClcblxuXHRcdCRzY29wZS5uZXdDaGFwdGVyID0gKGRvY3VtZW50KSAtPlxuXHRcdFx0ZG9jdW1lbnQuY2hhcHRlcnMucHVzaFxuXHRcdFx0XHR0aXRsZTogJHNjb3BlLm5ld0NoYXB0ZXJUaXRsZVxuXHRcdFx0XHRhdXRob3I6IGNoYW5jZS5uYW1lKClcblx0XHRcdFx0bGFzdENoYW5nZWQ6IG5ldyBEYXRlKClcblx0XHRcdFx0c3RhdGU6ICdPTkdPSU5HJ1xuXHRcdFx0XHRjb21tZW50czogW11cblx0XHRcdFx0dmVyc2lvbjogMVxuXHRcdFx0JHNjb3BlLm5ld0NoYXB0ZXJUaXRsZSA9ICcnXG5cdFx0XHQkc2NvcGUuc2VsZWN0Q2hhcHRlcihfLmxhc3QgZG9jdW1lbnQuY2hhcHRlcnMpXG5cdFx0XHRhdXRvU2F2ZSgpXG5cblx0XHQkc2NvcGUuc2F2ZURvY3VtZW50ID0gKGRvY3VtZW50LCBtc2cgPSBcIkd1dGFjaHRlbiBlcmZvbGdyZWljaCBnZXNwZWljaGVydFwiKSAtPlxuXHRcdFx0RGF0YS5zYXZlRG9jdW1lbnQoZG9jdW1lbnQpLnRoZW4gKHJlc3BvbnNlKSAtPlxuXHRcdFx0XHRpZiByZXNwb25zZS5zdGF0dXMgIT0gMjAwXG5cdFx0XHRcdFx0bWVzc2FnZUNlbnRlclNlcnZpY2UuYWRkKCdkYW5nZXInLCBtc2csIHtodG1sOiB0cnVlfSk7XG5cdFx0XHRcdGVsc2Vcblx0XHRcdFx0XHRtZXNzYWdlQ2VudGVyU2VydmljZS5hZGQoJ3N1Y2Nlc3MnLCBtc2csIHt0aW1lb3V0OiAyMDAwLCBodG1sOiB0cnVlfSk7XG5cblx0XHQkc2NvcGUuZG9jU3RhdGVDaGFuZ2VkID0gKHZhbCkgLT5cblx0XHRcdGNvbnNvbGUubG9nICRzY29wZS5jdXJyZW50RG9jdW1lbnQuc3RhdGVcblxuXHRcdGlmICRzdGF0ZVBhcmFtcy5kb2NpZFxuXHRcdFx0RGF0YS5kb2N1bWVudCgkc3RhdGVQYXJhbXMuZG9jaWQpLnRoZW4gKGRvY3VtZW50KSAtPlxuXHRcdFx0XHRjb25zb2xlLmRpciBkb2N1bWVudFxuXHRcdFx0XHQkc2NvcGUuY3VycmVudERvY3VtZW50ID0gZG9jdW1lbnRcblx0XHRcdFx0JHNjb3BlLnNlbGVjdENoYXB0ZXIoJHNjb3BlLmN1cnJlbnREb2N1bWVudC5jaGFwdGVyc1swXSlcblx0XHRlbHNlXG5cdFx0XHQkc3RhdGUuZ28gJ2xpc3QnXG5dXG4iXX0=